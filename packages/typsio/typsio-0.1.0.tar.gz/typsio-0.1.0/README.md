# `typsio` - ç±»å‹å®‰å…¨çš„ Socket.IO RPC æ¡†æ¶

[![PyPI version](https://badge.fury.io/py/typsio.svg)](https://badge.fury.io/py/typsio)
[![npm version](https://badge.fury.io/js/typsio-client.svg)](https://badge.fury.io/js/typsio-client)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**`typsio`** (Typed Socket.IO) æ˜¯ä¸€ä¸ªè½»é‡çº§ã€éä¾µå…¥å¼çš„åº“ï¼Œæ—¨åœ¨ä¸ºæ‚¨çš„ `python-socketio` å’Œ `socket.io-client` åº”ç”¨å¸¦æ¥ç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ã€‚å®ƒé€šè¿‡åŒæ­¥ Python åç«¯å’Œ TypeScript å‰ç«¯ä¹‹é—´çš„å‡½æ•°ç­¾åå’Œæ•°æ®æ¨¡å‹ï¼Œä½¿æ‚¨èƒ½å¤Ÿåˆ›å»ºå¥å£®ã€å¯ç»´æŠ¤ä¸”ä¸æ˜“å‡ºé”™çš„å®æ—¶åº”ç”¨ã€‚

å‘Šåˆ«çŒœæµ‹äº‹ä»¶è´Ÿè½½ï¼ˆpayloadï¼‰ç»“æ„çš„æ—¶ä»£ã€‚æœ‰äº† `typsio`ï¼Œæ‚¨çš„ä»£ç ç¼–è¾‘å™¨å°†æˆä¸ºæ‚¨æŠµå¾¡ Bug çš„ç¬¬ä¸€é“é˜²çº¿ã€‚

## âœ¨ ç‰¹æ€§

- **ğŸš€ ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**: åœ¨ Python ä¸­å…±äº« Pydantic æ¨¡å‹ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ TypeScript æ¥å£ã€‚åœ¨ç¼–è¯‘æ—¶è€Œä¸æ˜¯è¿è¡Œæ—¶æ•è·æ•°æ®ç±»å‹ä¸åŒ¹é…çš„é”™è¯¯ã€‚
- **âœ¨ å£°æ˜å¼ API**: ä½¿ç”¨ç®€å•çš„ `@rpc.register` è£…é¥°å™¨å³å¯å®šä¹‰æ‚¨çš„ RPC æ–¹æ³•ï¼Œæ— éœ€å¤æ‚çš„æ ·æ¿ä»£ç ã€‚
- **ğŸ”„ åŒå‘é€šä¿¡**: å®Œå…¨æ”¯æŒå®¢æˆ·ç«¯è°ƒç”¨çš„ RPC å’ŒæœåŠ¡å™¨æ¨é€çš„äº‹ä»¶ï¼Œä¸¤è€…éƒ½å®Œå…¨ç±»å‹åŒ–ã€‚
- **ğŸ§© éä¾µå…¥å¼è®¾è®¡**: `typsio` ä¸æ‚¨ç°æœ‰çš„ `python-socketio` æœåŠ¡å™¨å’Œ `socket.io-client` å®ä¾‹é›†æˆï¼Œæ— éœ€è¿›è¡Œå¤§è§„æ¨¡é‡æ„ã€‚
- **ğŸ› ï¸ ä»£ç ç”Ÿæˆ**: ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»æ‚¨çš„ Python API å®šä¹‰ç”Ÿæˆ TypeScript ç±»å‹ã€‚
- **ğŸ”— å¥å£®çš„è®¾è®¡**: ä½¿ç”¨æ³¨å†Œè¡¨æ¨¡å¼æ¥å®šä¹‰ APIï¼Œä»æ ¹æœ¬ä¸Šé¿å…äº†å¤§å‹ Python åº”ç”¨ä¸­å¸¸è§çš„å¾ªç¯å¯¼å…¥é—®é¢˜ã€‚

## ğŸ“¦ å®‰è£…

### åç«¯ (Python)

Python åŒ…å°†å‘å¸ƒåˆ° PyPIã€‚

```bash
# ä½¿ç”¨ pip å®‰è£…
pip install typsio

# æˆ–è€…ï¼Œåœ¨æ­¤ monorepo ä¸­è¿›è¡Œæœ¬åœ°å¼€å‘
pip install -e packages/py_typsio
```

### å‰ç«¯ (TypeScript)

å®¢æˆ·ç«¯åŒ…å°†å‘å¸ƒåˆ° npmã€‚

```bash
# ä½¿ç”¨ npm å®‰è£…
npm install typsio-client socket.io-client

# æˆ–è€…ï¼Œåœ¨æ­¤ monorepo ä¸­è¿›è¡Œæœ¬åœ°å¼€å‘
npm install file:packages/ts_typsio
```

## ğŸš€ å¿«é€Ÿå…¥é—¨ï¼šè¿è¡Œç¤ºä¾‹

é€šè¿‡è¿è¡Œé™„å¸¦çš„ç¤ºä¾‹é¡¹ç›®ï¼Œåœ¨ 5 åˆ†é’Ÿå†…ä½“éªŒ `typsio`ã€‚

### å…ˆå†³æ¡ä»¶

- Python 3.8+ å’Œè™šæ‹Ÿç¯å¢ƒå·¥å…· (å¦‚ `venv`)ã€‚
- [uv](https://github.com/astral-sh/uv) (æ¨èç”¨äºè¿è¡Œè„šæœ¬): `pip install uv`
- Node.js å’Œ npmã€‚
- `json-schema-to-typescript`: `npm install -g json-schema-to-typescript`

### 1. å¯åŠ¨åç«¯æœåŠ¡å™¨

```bash
# è¿›å…¥åç«¯ç¤ºä¾‹ç›®å½•
cd examples/backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
uv venv
uv pip install -e . # pyproject.toml å·²ä¸ºæœ¬åœ°å¼€å‘é…ç½®

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
uv run dev
```

åç«¯æœåŠ¡å™¨ç°åœ¨è¿è¡Œåœ¨ `http://localhost:8000`ã€‚

### 2. å¯åŠ¨å‰ç«¯å®¢æˆ·ç«¯

åœ¨æ–°çš„ç»ˆç«¯ä¸­ï¼š

```bash
# è¿›å…¥å‰ç«¯ç¤ºä¾‹ç›®å½•
cd examples/frontend

# å®‰è£…ä¾èµ– (è¿™å°†é“¾æ¥åˆ°æœ¬åœ°çš„ typsio-client åŒ…)
npm install

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
npm run dev
```

å‰ç«¯å°†åœ¨ `http://localhost:5173` (å¦‚æœ 5173 ç«¯å£è¢«å ç”¨ï¼Œå¯èƒ½ä¼šæ˜¯å…¶ä»–ç«¯å£) ä¸Šå¯ç”¨ã€‚

### 3. æŸ¥çœ‹å®é™…æ•ˆæœï¼

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å‰ç«¯ URLã€‚æ§åˆ¶å°å°†æ˜¾ç¤ºï¼š
1.  æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨ã€‚
2.  `get_user(1)` RPC è°ƒç”¨çš„ç»“æœã€‚
3.  `send_message` RPC è°ƒç”¨æˆåŠŸçš„ç¡®è®¤ä¿¡æ¯ã€‚

## ğŸ’» å¼€å‘å·¥ä½œæµ

è¿™æ˜¯ `typsio` é¡¹ç›®çš„æ ¸å¿ƒå¼€å‘å¾ªç¯ã€‚

### 1. åœ¨ Python ä¸­å®šä¹‰æ‚¨çš„ API

ä½¿ç”¨ Pydantic å®šä¹‰æ•°æ®æ¨¡å‹ï¼Œå¹¶åœ¨ä¸€ä¸ªä¸­å¿ƒæ–‡ä»¶ä¸­æ³¨å†Œæ‚¨çš„ RPC å‡½æ•°ã€‚è¯¥æ–‡ä»¶æ˜¯æ‚¨ API å½¢æ€çš„å”¯ä¸€çœŸå®æ¥æºã€‚

**`examples/backend/src/my_app/api_defs.py`**
```python
from pydantic import BaseModel, Field
from typsio import RPCRegistry
import datetime

# 1. å®šä¹‰æ•°æ®æ¨¡å‹
class User(BaseModel):
    id: int
    name: str

# 2. åˆ›å»º RPC æ³¨å†Œè¡¨
rpc_registry = RPCRegistry()

# 3. æ³¨å†Œ RPC å‡½æ•°
@rpc_registry.register
async def get_user(user_id: int) -> User | None:
    # ... å®ç°é€»è¾‘ ...

@rpc_registry.register
def send_message(message: Message) -> bool:
    # ... å®ç°é€»è¾‘ ...

# 4. (å¯é€‰) å®šä¹‰æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„äº‹ä»¶
class Notification(BaseModel):
    message: str
    timestamp: datetime.datetime

SERVER_EVENTS = {
    "newNotification": Notification
}
```

### 2. ç”Ÿæˆ TypeScript ç±»å‹

è¿è¡Œç”Ÿæˆå™¨ï¼Œåˆ›å»ºä¸€ä¸ªä¸æ‚¨çš„ Python å®šä¹‰ç›¸åŒ¹é…çš„ TypeScript æ–‡ä»¶ã€‚ç¤ºä¾‹é¡¹ç›®å·²å°†å…¶é…ç½®ä¸º `npm` è„šæœ¬ã€‚

```bash
# åœ¨ examples/frontend/ ç›®å½•ä¸‹
npm run gen-types
```

æ­¤å‘½ä»¤æ‰§è¡Œ `examples/backend/pyproject.toml` ä¸­å®šä¹‰çš„è„šæœ¬ï¼š
`python ../../../generator/typsio_gen.py src/my_app/api_defs.py ...`

å®ƒä¼šç”Ÿæˆæ­¤æ–‡ä»¶ï¼š

**`examples/frontend/src/generated/api-types.ts`**
```typescript
/* eslint-disable */
/**
* This file was automatically generated by typsio-gen.
* DO NOT MODIFY IT BY HAND.
*/

export interface TypsioModels { /* ... */ }
export interface User { /* ... */ }
// ... å…¶ä»–æ¨¡å‹

export interface RPCMethods {
  get_user(user_id: number): Promise<User | null>;
  send_message(message: Message): Promise<boolean>;
}

export interface ServerToClientEvents {
  'newNotification': (payload: Notification) => void;
}
```

### 3. ä½¿ç”¨ç±»å‹å®‰å…¨çš„å®¢æˆ·ç«¯

ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨å‰ç«¯ä»£ç ä¸­å¯¼å…¥å’Œä½¿ç”¨å®¢æˆ·ç«¯ï¼Œå¹¶è·å¾—å®Œå…¨çš„ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚

**`examples/frontend/src/api.ts`**
```typescript
import { io } from 'socket.io-client';
import { createTypsioClient } from 'typsio-client';
// å¯¼å…¥ç”Ÿæˆçš„ç±»å‹
import type { RPCMethods, ServerToClientEvents } from './generated/api-types';

const socket = io('http://localhost:8000');

// åˆ›å»ºå®¢æˆ·ç«¯ï¼Œå°†ç”Ÿæˆçš„ç±»å‹ä½œä¸ºæ³›å‹ä¼ å…¥
const client = createTypsioClient<ServerToClientEvents, RPCMethods>(socket);

export const api = client.remote; // å®Œå…¨ç±»å‹åŒ–çš„ RPC æ–¹æ³•
export const on = client.on;       // å®Œå…¨ç±»å‹åŒ–çš„äº‹ä»¶ç›‘å¬å™¨
```

**`examples/frontend/src/main.ts`**
```typescript
import { api, on } from './api';

// è‡ªåŠ¨è¡¥å…¨çŸ¥é“ `get_user` æ¥å—ä¸€ä¸ªæ•°å­—å¹¶è¿”å› Promise<User | null>
const user = await api.get_user(1);

if (user) {
  // è‡ªåŠ¨è¡¥å…¨çŸ¥é“ `user` çš„ç»“æ„
  console.log(user.name);

  // å¦‚æœæ‚¨å°è¯•å‘é€é”™è¯¯çš„ç»“æ„ï¼ŒTypeScript å°†ä¼šæŠ¥é”™
  await api.send_message({ text: 'æ¥è‡ªç±»å‹åŒ–å®¢æˆ·ç«¯çš„æ¶ˆæ¯!', user });
}

// `on` ç›‘å¬å™¨çŸ¥é“ `newNotification` å…·æœ‰ç‰¹å®šçš„è´Ÿè½½ç±»å‹
on('newNotification', (payload) => {
  console.log(payload.message);
});
```

é€šè¿‡æ­¤å·¥ä½œæµï¼Œæ‚¨çš„ Python åç«¯å’Œ TypeScript å‰ç«¯å°†å§‹ç»ˆä¿æŒåŒæ­¥ã€‚

## ğŸ› ï¸ å¼€å‘ (Contributing)

æˆ‘ä»¬éå¸¸æ¬¢è¿ç¤¾åŒºçš„è´¡çŒ®ï¼å¦‚æœæ‚¨æƒ³æ”¹è¿› `typsio`ï¼Œè¯·éµå¾ªä»¥ä¸‹æŒ‡å—ã€‚

### é¡¹ç›®ç»“æ„

æœ¬ä»“åº“æ˜¯ä¸€ä¸ª monorepoï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

- `packages/`: åŒ…å« `py_typsio` (Python æ ¸å¿ƒåº“) å’Œ `ts_typsio` (TypeScript å®¢æˆ·ç«¯) çš„æºä»£ç ã€‚
- `generator/`: åŒ…å«ä» Python ä»£ç ç”Ÿæˆ TypeScript ç±»å‹çš„æ ¸å¿ƒè„šæœ¬ã€‚
- `examples/`: åŒ…å«ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹é¡¹ç›®ï¼Œç”¨äºæ‰‹åŠ¨æµ‹è¯•å’Œæ¼”ç¤ºã€‚

### ç¯å¢ƒè®¾ç½®

1.  **Fork & Clone**: é¦–å…ˆï¼ŒFork æœ¬ä»“åº“ï¼Œç„¶åå°†æ‚¨çš„ Fork å…‹éš†åˆ°æœ¬åœ°ã€‚

2.  **åç«¯ (`py_typsio`)**: è¦å¯¹ Python æ ¸å¿ƒåº“è¿›è¡Œæ›´æ”¹ï¼Œè¯·è®¾ç½®ä»¥ä¸‹ç¯å¢ƒï¼š
    ```bash
    # cd typsio
    # with venv
    uv venv
    uv pip install -e packages/py_typsio
    # without venv
    python -m venv .venv
    pip install -e packages/py_typsio
    ```

3.  **å‰ç«¯ (`ts_typsio`)**: è¦å¯¹ TypeScript å®¢æˆ·ç«¯è¿›è¡Œæ›´æ”¹ï¼š
    ```bash
    cd packages/ts_typsio
    npm install
    ```

### æ‰“åŒ…

è¦å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ `scripts/` ç›®å½•ä¸­çš„å‘å¸ƒè„šæœ¬ï¼š

```bash
# For Linux/macOS
./scripts/publish.sh

# For Windows
./scripts/publish.ps1
```

ç¡®ä¿åœ¨è¿è¡Œè„šæœ¬ä¹‹å‰æ›´æ–°ä¸¤ä¸ªåŒ…çš„ç‰ˆæœ¬å·ï¼š
- Python åŒ…ç‰ˆæœ¬åœ¨ `packages/py_typsio/pyproject.toml` ä¸­
- TypeScript åŒ…ç‰ˆæœ¬åœ¨ `packages/ts_typsio/package.json` ä¸­

è¯¦ç»†è¯´æ˜è¯·å‚è§ [scripts/README.md](scripts/README.md)ã€‚

### è¿è¡Œæµ‹è¯•

åœ¨æäº¤ä»£ç ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‰€æœ‰æµ‹è¯•éƒ½å·²é€šè¿‡ã€‚

- **Python**: `cd packages/py_typsio && pytest`
- **TypeScript**: `cd packages/ts_typsio && npm test`

*(æ³¨æ„: æµ‹è¯•è„šæœ¬å’Œä¾èµ–å¯èƒ½éœ€è¦æ‚¨æ ¹æ®éœ€è¦è¿›è¡Œé…ç½®)*

### æäº¤è´¡çŒ®

1.  ä» `main` åˆ†æ”¯åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰¹æ€§åˆ†æ”¯ (`git checkout -b my-awesome-feature`)ã€‚
2.  è¿›è¡Œæ‚¨çš„ä¿®æ”¹ã€‚
3.  ç¡®ä¿ä»£ç é€šè¿‡äº†æµ‹è¯•å’Œ lint æ£€æŸ¥ã€‚
4.  æäº¤ä¸€ä¸ª Pull Requestï¼Œæ¸…æ™°åœ°æè¿°æ‚¨æ‰€åšçš„æ›´æ”¹å’ŒåŸå› ã€‚

æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼