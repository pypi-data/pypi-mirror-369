import{r as a,E as k,_ as H,u as B,aJ as R,aK as G,m as x,aL as X,aM as $,aN as z,aO as L,aP as K,aQ as Q,o as F,aR as M,x as _,aS as Y,aT as Z,aU as q,J as ee,aV as te,j as N,e as ne,aW as se,aX as ae,aY as re}from"./index.BcHVYbLW.js";import{w as oe,E as ie}from"./withFullScreenWrapper.DwjL5pUM.js";import{a as I,S as W,T as ce}from"./Toolbar.DmO9uS7R.js";import{R as le}from"./index.Bl1MOEpk.js";import{u as ue}from"./FormClearHelper.D537hQuL.js";import"./sprintf.D7DtBTRn.js";import"./checkbox.CSsKJzsE.js";import"./createDownloadLinkElement.ZaXNnPK4.js";import"./toConsumableArray.DXjnWtwc.js";import"./possibleConstructorReturn.D_HrTBN8.js";import"./createSuper.WYsMy9MH.js";import"./FileDownload.esm.DWqSE9TZ.js";var J=a.forwardRef(function(n,t){var r={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return a.createElement(k,H({iconAttrs:r,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),a.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),a.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});J.displayName="InsertChart";var P=a.forwardRef(function(n,t){var r={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return a.createElement(k,H({iconAttrs:r,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),a.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),a.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});P.displayName="TableChart";const fe=20;function de(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&x(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const me=(n,t,r,s,o,f,u,h)=>{const e=JSON.parse(n);if(r==="streamlit"?e.config=R(e.config,o):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=R(e.config,o),e.usermeta.embedOptions.theme=void 0):e.config=G(e.config,o),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(u-40,0)),f?(e.width=u,e.height=h,"vconcat"in e&&e.vconcat.forEach(l=>{l.width=u})):t&&(e.width=u,"vconcat"in e&&e.vconcat.forEach(l=>{l.width=u})),e.padding||(e.padding={}),x(e.padding.bottom)&&(e.padding.bottom=fe),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return s.length>0&&de(e),e},he=(n,t,r,s)=>{const o=B(),{id:f,formId:u,spec:h,data:e,datasets:l,useContainerWidth:i,vegaLiteTheme:p,selectionMode:c}=n,S=a.useMemo(()=>c,[JSON.stringify(c)]),y=a.useMemo(()=>me(h,i,p,S,o,t,r||0,s),[h,i,p,S,o,t,r,s]);return{id:f,formId:u,vegaLiteTheme:p,spec:y,selectionMode:S,data:e,datasets:l,useContainerWidth:i}},pe={DATAFRAME_INDEX:"(index)"};function ge(n){return!n||n.dimensions.numDataRows===0?null:A(n)}function Se(n){const t=D(n);if(x(t))return null;const r={};for(const[s,o]of Object.entries(t))r[s]=A(o);return r}function D(n){if(n?.length===0)return null;const t={};return n.forEach(r=>{if(!r)return;const s=r.hasName?r.name:null;t[s]=r.data}),t}function A(n,t=0){if(n.dimensions.numDataRows===0)return[];const r=[],{numDataRows:s,numDataColumns:o,numIndexColumns:f}=n.dimensions,u=n.columnTypes[0]??void 0,h=u&&u.type===X.INDEX&&($(u)||z(u)||L(u));for(let e=t;e<s;e++){const l={};if(h){const{content:i}=n.getCell(e,0);l[pe.DATAFRAME_INDEX]=typeof i=="bigint"?Number(i):i}for(let i=0;i<o;i++){const p=i+f,{content:c,contentType:S}=n.getCell(e,p);if((c instanceof Date||typeof c=="number"&&Number.isFinite(c))&&(z(S)||L(S))&&!K(S)){const y=new Date(c).getTimezoneOffset()*60*1e3;l[n.columnNames[0][p]]=c.valueOf()+y}else l[n.columnNames[0][p]]=typeof c=="bigint"?Number(c):c}r.push(l)}return r}const ye=150,we=_.getLogger("useVegaLiteSelections"),be=(n,t,r)=>{const{id:s,formId:o,selectionMode:f}=n,u=a.useCallback(e=>{f.forEach(i=>{e.addSignalListener(i,Q(ye,(p,c)=>{const S=e.getState({data:(w,b)=>f.some(v=>`${v}_store`===w),recurse:!1});F(S)&&t.setElementState(s,"viewState",S);let y=c;"vlPoint"in c&&"or"in c.vlPoint&&(y=c.vlPoint.or);const E={id:s,formId:o},g=JSON.parse(t.getStringValue(E)||"{}"),d={selection:{...g?.selection||{},[p]:y||{}}};M(g,d)||t.setStringValue(E,JSON.stringify(d),{fromUi:!0},r)}))});const l=t.getElementState(s,"viewState");if(F(l))try{return e.setState(l)}catch(i){we.warn("Failed to restore view state",i)}return e},[s,f,t,o,r]),h=a.useCallback(()=>{const e={selection:{}};f.forEach(c=>{e.selection[c]={}});const l={id:s,formId:o},i=t.getStringValue(l),p=i?JSON.parse(i):e;M(p,e)||t.setStringValue(l,JSON.stringify(e),{fromUi:!0},r)},[s,o,r,f,t]);return{maybeConfigureSelections:u,onFormCleared:h}},j="source",Ce=_.getLogger("useVegaEmbed");function Ee(n,t,r){const s=a.useRef(null),o=a.useRef(null),f=a.useRef(j),u=a.useRef(null),h=a.useRef([]),{maybeConfigureSelections:e,onFormCleared:l}=be(n,t,r);ue({widgetMgr:t,element:n,onFormCleared:l});const{data:i,datasets:p}=n;a.useEffect(()=>{s.current===null&&(u.current=i,h.current=p)},[i,p]);const c=a.useCallback(()=>{o.current&&o.current(),o.current=null,s.current=null},[]),S=a.useCallback(async(g,d)=>{if(g.current===null)throw new Error("Element missing.");c();const w={ast:!0,expr:Z,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:b,view:v,finalize:C}=await Y(g.current,d,w);s.current=e(v),o.current=C;const m=Se(h.current),V=m?Object.keys(m):[];if(V.length===1){const[T]=V;f.current=T}else V.length===0&&b.data&&(f.current=j);const O=ge(u.current);if(O&&s.current.insert(f.current,O),m)for(const[T,U]of Object.entries(m))s.current.insert(T,U);return await s.current.runAsync(),await s.current.resize().runAsync(),s.current},[c,e]),y=a.useCallback((g,d,w,b)=>{if(!b||b.dimensions.numDataRows===0){try{g.remove(d,q)}finally{}return}if(!w||w.dimensions.numDataRows===0){g.insert(d,A(b));return}b.hash!==w.hash&&(g.data(d,A(b)),Ce.info(`Had to clear the ${d} dataset before inserting data through Vega view.`))},[]),E=a.useCallback(async(g,d)=>{if(s.current===null)return null;const w=u.current,b=h.current;(w||g)&&y(s.current,f.current,w,g);const v=D(b)??{},C=D(d)??{};for(const[m,V]of Object.entries(C)){const O=m||f.current,T=v[O];y(s.current,O,T,V)}for(const m of Object.keys(v))!Object.hasOwn(C,m)&&m!==f.current&&y(s.current,m,null,null);return await s.current?.resize().runAsync(),u.current=g,h.current=d,s.current},[y]);return{createView:S,updateView:E,finalizeView:c}}function ve(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const Ve=({disableFullscreenMode:n,element:t,fragmentId:r,widgetMgr:s})=>{const[o,f]=a.useState(!1),[u,h]=a.useState(!1),{expanded:e,height:l,width:i,expand:p,collapse:c}=ee(ie),{values:[S,y],elementRef:E}=te(a.useMemo(()=>["width","height"],[]),[o]),g=ve(t.spec),d=he(t,e,g?i??0:S,l??0),{createView:w,updateView:b,finalizeView:v}=Ee(d,s,r),{data:C,datasets:m,spec:V}=d;return a.useLayoutEffect(()=>(E.current!==null&&w(E,V),v),[w,v,V,i,l,o,E]),a.useEffect(()=>{b(C,m)},[C,m,b]),a.useEffect(()=>{C||m&&m[0]?.data?h(!0):h(!1)},[C,m]),o?N(le,{data:C??m[0]?.data,height:l??y??void 0,customToolbarActions:[N(I,{label:"Show chart",icon:J,onClick:()=>{f(!1)}},"show-chart")]}):ne(W,{height:l,useContainerWidth:d.useContainerWidth,children:[N(ce,{target:W,isFullScreen:e,onExpand:p,onCollapse:c,disableFullscreenMode:n,children:u&&N(I,{label:"Show data",icon:P,onClick:()=>{f(!0)}})}),N(ae,{styles:[se]}),N(re,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:d.useContainerWidth,isFullScreen:e,ref:E})]})},Ne=oe(Ve),je=a.memo(Ne);export{se as StyledVegaLiteChartTooltips,R as applyStreamlitTheme,je as default};
