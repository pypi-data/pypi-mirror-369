name: Publish Python Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip --disable-pip-version-check

      - name: Install build dependencies
        run: pip install --upgrade build twine

      - name: Verify that tag is from main
        run: |
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          git fetch origin "$DEFAULT_BRANCH" --quiet
          TAG_COMMIT=$(git rev-list -n 1 "$GITHUB_REF")

          echo "üìå Default branch: $DEFAULT_BRANCH"
          echo "üìå Tag commit: $TAG_COMMIT"
          echo "üìå Latest commit in $DEFAULT_BRANCH: $(git rev-parse origin/$DEFAULT_BRANCH)"

          if ! git merge-base --is-ancestor "$TAG_COMMIT" "origin/$DEFAULT_BRANCH"; then
              echo "‚ùå Tag is not from $DEFAULT_BRANCH. Exiting."
              exit 1
          fi
          echo "‚úÖ Tag is from $DEFAULT_BRANCH"

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload --non-interactive dist/*
