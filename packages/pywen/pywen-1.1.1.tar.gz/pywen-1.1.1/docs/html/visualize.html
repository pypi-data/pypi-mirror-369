<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Agent Trajectory Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Markdown render + sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <style>
    :root{
      --bg:#0b0d12;--card:#121622;--muted:#1a2030;--border:#2a3348;--text:#e6e9f2;--sub:#a7b0c3;--accent:#7aa2ff;
      --pill-bg:#0f1729;--pill-br:#2a3a6b;--good:#2ecc71;--warn:#f1c40f;--bad:#e74c3c;--shadow:0 6px 24px rgba(0,0,0,.35),0 2px 8px rgba(0,0,0,.25);
      --radius:16px;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%;overflow-x:hidden}
    body{margin:0;background:linear-gradient(180deg,#0a0d14,#0b0d12 40%);color:var(--text);font-family:var(--sans)}
    .container{max-width:1280px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .file-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
    .file-name{color:var(--sub);font-size:.9rem}
    .hint{color:#8fb1ff;font-size:.9rem}
    .card{background:linear-gradient(180deg,#121622,#101522 60%,#0e1320);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);margin-top:16px}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:1rem}
    .card-body{padding:12px 16px}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr}
    @media (min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--pill-br);border-radius:999px;background:var(--pill-bg);color:#cfe1ff;font-family:var(--mono);font-size:.85rem;margin:4px 6px 0 0;text-decoration:none}
    .pill.badge{cursor:default}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:10px;background:#0d1424;color:#cfe1ff;font-size:.8rem;margin:2px 6px 0 0}
    .section-title{font-weight:700;margin:8px 0 6px}
    .bubble{background:var(--muted);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin:8px 0}
    .small{font-size:.9rem}
    pre,code{font-family:var(--mono);white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
    .bubble,.bubble *{word-break:break-word;overflow-wrap:anywhere}
    .io-grid{display:grid;grid-template-columns:3fr 1fr;gap:16px}
    @media (max-width:900px){.io-grid{grid-template-columns:1fr}}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0e1424;color:#cfe1ff;cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    details.section>summary{cursor:pointer;padding:8px 10px;border:1px solid var(--border);background:var(--muted);border-radius:10px;user-select:none;font-weight:600}
    details.section[open]>summary{background:#101629}
    .section-body{margin-top:8px}
    .progress{height:10px;border-radius:6px;background:#0f1424;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%}
    .bar.total{background:#2d6cdf}
    .bar.in{background:#27ae60}
    .bar.out{background:#c97c1a}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:.92rem;margin:8px 0}
    .idx{color:var(--sub)}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <label class="file-btn">
        <input id="fileInput" type="file" accept=".json,application/json" hidden />
        <span>Choose trajectory JSON</span>
      </label>
      <button id="expandAllBtn" class="btn">Expand all</button>
      <button id="collapseAllBtn" class="btn">Collapse all</button>
      <span id="fileName" class="file-name">No file chosen</span>
      <span id="metaInfo" class="hint"></span>
    </div>

    <!-- Summary -->
    <div class="card">
      <h3>Run Summary</h3>
      <div class="card-body" id="summaryBody">
        <div class="muted small">Load a JSON file to see details.</div>
      </div>
    </div>

    <!-- Usage -->
    <div class="card">
      <h3>Token Usage</h3>
      <div class="card-body" id="usageBody">
        <div class="muted small">—</div>
      </div>
    </div>

    <!-- Tools -->
    <div class="card">
      <h3>Tools Catalog</h3>
      <div class="card-body" id="toolsBody">
        <div class="muted small">—</div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="card">
      <h3>LLM Interactions Timeline</h3>
      <div class="card-body" id="timelineBody">
        <div class="muted small">—</div>
      </div>
    </div>

    <!-- Agent Steps -->
    <div class="card">
      <h3>Agent Steps</h3>
      <div class="card-body" id="stepsBody">
        <div class="muted small">—</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const el = id => document.getElementById(id);
    const fileInput = el('fileInput');
    const fileNameEl = el('fileName');
    const metaInfoEl = el('metaInfo');
    const summaryBody = el('summaryBody');
    const usageBody = el('usageBody');
    const toolsBody = el('toolsBody');
    const timelineBody = el('timelineBody');
    const stepsBody = el('stepsBody');

    function md(htmlText){
      const raw = (window.marked && typeof marked.parse==='function') ? marked.parse(htmlText||'') : (htmlText||'');
      const clean = (window.DOMPurify && DOMPurify.sanitize) ? DOMPurify.sanitize(raw) : raw;
      const div = document.createElement('div'); div.innerHTML = clean; return div;
    }
    function codeBlock(text){ const pre = document.createElement('pre'); pre.textContent = text ?? ''; return pre; }
    function pill(label){ const a=document.createElement('span'); a.className='pill badge'; a.textContent=label; return a; }
    function tag(label){ const s=document.createElement('span'); s.className='tag'; s.textContent=label; return s; }
    function pretty(obj){ try{return JSON.stringify(obj,null,2)}catch{return String(obj)} }
    function textBubble(str){ const b=document.createElement('div'); b.className='bubble small'; b.appendChild(md(String(str||''))); return b; }
    function makeSectionCollapsible(title, count, innerNode, open=false){
      const details=document.createElement('details'); details.className='section'; if(open) details.setAttribute('open','');
      const summary=document.createElement('summary'); summary.innerHTML = title + (typeof count==='number' ? ` <span class="pill badge">count: ${count}</span>` : '');
      const body=document.createElement('div'); body.className='section-body'; if(innerNode) body.appendChild(innerNode);
      details.appendChild(summary); details.appendChild(body);
      return details;
    }
    function expandOrCollapseAll(open){
      document.querySelectorAll('details').forEach(d => open ? d.setAttribute('open','') : d.removeAttribute('open'));
    }
    el('expandAllBtn').onclick = () => expandOrCollapseAll(true);
    el('collapseAllBtn').onclick = () => expandOrCollapseAll(false);

    // ---------- Parsing ----------
    function parseTrajectoryJson(raw){
      // Accept string or object
      const data = (typeof raw === 'string') ? JSON.parse(raw) : raw;
      // Normalize
      const interactions = Array.isArray(data.llm_interactions) ? data.llm_interactions : [];
      const steps = Array.isArray(data.agent_steps) ? data.agent_steps : [];
      return { data, interactions, steps };
    }

    // ---------- Render: Summary ----------
    function renderSummary(d){
      summaryBody.innerHTML='';
      const kv = document.createElement('div'); kv.className='kv';
      const rows = [
        ['Task', d.task ?? '—'],
        ['Provider', d.provider ?? '—'],
        ['Model', d.model ?? '—'],
        ['Max Steps', d.max_steps ?? '—'],
        ['Success', String(Boolean(d.success))],
        ['Start Time', d.start_time || '—'],
        ['End Time', d.end_time || '—'],
        ['Execution Time (s)', (typeof d.execution_time==='number' ? d.execution_time.toFixed(3) : '—')],
        ['LLM Interactions', Array.isArray(d.llm_interactions) ? d.llm_interactions.length : 0],
        ['Agent Steps', Array.isArray(d.agent_steps) ? d.agent_steps.length : 0],
      ];
      rows.forEach(([k,v])=>{
        const kdiv=document.createElement('div'); kdiv.textContent=k;
        const vdiv=document.createElement('div'); vdiv.appendChild(document.createTextNode(String(v)));
        kv.appendChild(kdiv); kv.appendChild(vdiv);
      });
      summaryBody.appendChild(kv);

      const chips = document.createElement('div'); chips.className='chips';
      if (d.success) chips.appendChild(pill('success'));
      if (d.total_tokens!=null) chips.appendChild(pill(`total_tokens:${d.total_tokens}`));
      if (d.total_input_tokens!=null) chips.appendChild(pill(`in:${d.total_input_tokens}`));
      if (d.total_output_tokens!=null) chips.appendChild(pill(`out:${d.total_output_tokens}`));
      if (d.context_tokens!=null) chips.appendChild(pill(`context:${d.context_tokens}`));
      summaryBody.appendChild(chips);
    }

    // ---------- Render: Usage ----------
    function barRow(label, value, max, cls){
      const row=document.createElement('div'); row.style.margin='6px 0';
      const head=document.createElement('div'); head.className='chips';
      head.appendChild(tag(label)); head.appendChild(pill(String(value ?? 0)));
      row.appendChild(head);
      const track=document.createElement('div'); track.className='progress';
      const bar=document.createElement('div'); bar.className='bar '+cls;
      const pct = (max>0) ? Math.max(2, Math.round((value/max)*100)) : 0;
      bar.style.width = Math.min(100,pct)+'%';
      track.appendChild(bar);
      row.appendChild(track);
      return row;
    }
    function renderUsage(d){
      usageBody.innerHTML='';
      const total = Number(d.total_tokens)||0;
      const vIn = Number(d.total_input_tokens)||0;
      const vOut = Number(d.total_output_tokens)||0;
      const max = Math.max(total, vIn, vOut, 1);
      usageBody.appendChild(barRow('Total', total, max, 'total'));
      usageBody.appendChild(barRow('Input', vIn, max, 'in'));
      usageBody.appendChild(barRow('Output', vOut, max, 'out'));

      const chips=document.createElement('div'); chips.className='chips';
      if (d.context_tokens!=null) chips.appendChild(pill(`context:${d.context_tokens}`));
      usageBody.appendChild(chips);
    }

    // ---------- Render: Tools ----------
    function renderTools(d){
      toolsBody.innerHTML='';
      const set = new Set();
      (d.llm_interactions||[]).forEach(it=>{
        (it.tools_available||[]).forEach(t=>set.add(t));
      });
      if (!set.size){ toolsBody.innerHTML='<div class="muted small">No tools recorded.</div>'; return; }
      const chips=document.createElement('div'); chips.className='chips';
      Array.from(set).sort().forEach(t => chips.appendChild(tag(t)));
      toolsBody.appendChild(chips);
    }

    // ---------- Render: one message (like original) ----------
    function renderMessageItem(msg){
      const holder=document.createElement('div');
      const bubble=document.createElement('div'); bubble.className='bubble';
      const head=document.createElement('div'); head.className='chips';
      head.appendChild(tag(msg.role||'(role?)'));
      bubble.appendChild(head);
      const contentBox=document.createElement('div'); contentBox.className='small';
      const content = msg.content;
      if (typeof content === 'string'){ contentBox.appendChild(md(content)); }
      else { contentBox.appendChild(codeBlock(pretty(content))); }
      bubble.appendChild(contentBox);
      holder.appendChild(bubble);
      return holder;
    }

    // ---------- Render: Interaction (collapsible) ----------
    function renderInteraction(it, idx){
      const details=makeSectionCollapsible(`Interaction #${idx+1} — ${it.model||''} — ${it.current_task||''} — ${it.timestamp||''}`, null, null, false);

      const inner=document.createElement('div'); inner.className='io-grid';

      // Left: Input (3/4)
      const left=document.createElement('div');
      const inputTitle=document.createElement('div'); inputTitle.className='section-title'; inputTitle.textContent='Input';
      left.appendChild(inputTitle);

      const msgs = Array.isArray(it.input_messages) ? it.input_messages : [];
      const sysWrap=document.createElement('div');
      const userWrap=document.createElement('div');
      const otherWrap=document.createElement('div');
      let sysCount=0,userCount=0,otherCount=0;

      msgs.forEach(m=>{
        const rendered = renderMessageItem(m);
        const role = (m.role||'').toLowerCase();
        if (role==='system'){ sysWrap.appendChild(rendered); sysCount++; }
        else if (role==='user'){ userWrap.appendChild(rendered); userCount++; }
        else { otherWrap.appendChild(rendered); otherCount++; }
      });

      if (sysCount>0) left.appendChild(makeSectionCollapsible('System', sysCount, sysWrap, false));
      if (userCount>0) left.appendChild(makeSectionCollapsible('User', userCount, userWrap, false));
      if (otherCount>0) left.appendChild(makeSectionCollapsible('Others', otherCount, otherWrap, false));

      const toolsArr = Array.isArray(it.tools_available) ? it.tools_available : [];
      if (toolsArr.length){
        const sec=document.createElement('div'); sec.className='small';
        sec.innerHTML='<div class="section-title">Allowed Tools</div>';
        const chips=document.createElement('div'); chips.className='chips';
        toolsArr.forEach(t=>chips.appendChild(tag(t)));
        sec.appendChild(chips); left.appendChild(sec);
      }

      // Right: Output (1/4)
      const right=document.createElement('div');
      const outTitle=document.createElement('div'); outTitle.className='section-title'; outTitle.textContent='Output';
      right.appendChild(outTitle);

      const resp = it.response || {};
      if (resp.content!=null) right.appendChild(textBubble(resp.content));
      const rc=document.createElement('div'); rc.className='chips';
      if (resp.finish_reason) rc.appendChild(pill(`stop:${resp.finish_reason}`));
      if (resp.model) rc.appendChild(pill(resp.model));
      const u = resp.usage||{};
      if (u.input_tokens!=null) rc.appendChild(pill(`in:${u.input_tokens}`));
      if (u.output_tokens!=null) rc.appendChild(pill(`out:${u.output_tokens}`));
      if (u.total_tokens!=null) rc.appendChild(pill(`total:${u.total_tokens}`));
      right.appendChild(rc);

      if (resp.tool_calls){
        const tc=document.createElement('div'); tc.className='small';
        tc.innerHTML='<div class="section-title">Tool Calls</div>';
        tc.appendChild(codeBlock(pretty(resp.tool_calls)));
        right.appendChild(tc);
      }

      inner.appendChild(left); inner.appendChild(right);
      const body=document.createElement('div'); body.appendChild(inner);
      details.querySelector('.section-body').appendChild(body);
      return details;
    }

    // ---------- Render: Timeline ----------
    function renderTimeline(interactions){
      timelineBody.innerHTML='';
      if (!interactions.length){ timelineBody.innerHTML='<div class="muted small">No interactions.</div>'; return; }
      interactions.forEach((it, idx)=>{
        timelineBody.appendChild(renderInteraction(it, idx));
      });
    }

    // ---------- Render: Agent Steps ----------
    function renderSteps(steps){
      stepsBody.innerHTML='';
      if (!steps.length){ stepsBody.innerHTML='<div class="muted small">No agent steps.</div>'; return; }
      steps.forEach((st, idx)=>{
        const d = makeSectionCollapsible(`Step #${idx+1}`, null, null, false);
        const body = d.querySelector('.section-body');
        const kv=document.createElement('div'); kv.className='kv';
        Object.entries(st).forEach(([k,v])=>{
          const kd=document.createElement('div'); kd.textContent=k;
          const vd=document.createElement('div'); 
          if (typeof v === 'string') vd.appendChild(md(v));
          else vd.appendChild(codeBlock(pretty(v)));
          kv.appendChild(kd); kv.appendChild(vd);
        });
        body.appendChild(kv);
        stepsBody.appendChild(d);
      });
    }

    // ---------- File handling ----------
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      fileNameEl.textContent = file.name;
      try{
        const text = await file.text();
        const { data, interactions, steps } = parseTrajectoryJson(text);

        // Header meta
        metaInfoEl.textContent = `Interactions: ${interactions.length} • Steps: ${steps.length}`;

        // Render
        renderSummary(data);
        renderUsage(data);
        renderTools(data);
        renderTimeline(interactions);
        renderSteps(steps);

        // After render: ensure the expand/collapse buttons apply now
        // (They act globally, no extra binding needed here.)
      }catch(err){
        alert('Failed to parse JSON: ' + (err?.message || err));
      }
    });

    // Optional: Auto-load an example file path if served with logs (disabled by default)
    // (Keep page clean—manual upload recommended)
  </script>
</body>
</html>

