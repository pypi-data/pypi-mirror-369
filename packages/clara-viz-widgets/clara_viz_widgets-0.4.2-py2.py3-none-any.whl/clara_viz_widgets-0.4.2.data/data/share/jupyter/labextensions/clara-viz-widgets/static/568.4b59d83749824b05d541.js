(self.webpackChunkclara_viz_widgets=self.webpackChunkclara_viz_widgets||[]).push([[568,379],{568:(e,t,i)=>{e.exports=i(367),e.exports.version=i(147).version},367:(e,t,i)=>{var n=i(337),s=i(431),o=i(80),a=i(147).version,d=n.DOMWidgetModel.extend({defaults:s.extend(n.DOMWidgetModel.prototype.defaults(),{_model_name:"WidgetModel",_view_name:"WidgetView",_model_module:"clara-viz-widgets",_view_module:"clara-viz-widgets",_model_module_version:a,_view_module_version:a}),nviews:0}),r=n.DOMWidgetView.extend({video:null,sourceBuffer:null,mediaSource:null,bufArray:null,streamOpen:!1,viewId:null,intersectionObserver:null,videoIsIntersecting:!1,touchedPoints:[],key:"",multiTouchDistance:0,multiTouchCenter:new o.Vector2(0,0),button:-1,datasetInfo:null,settings:null,debug:function(e){console.log(`[view ${this.viewId}]: `+e)},initialize:function(e,t){r.__super__.initialize.call(this,e,t),this.model.on("change:_settings",this.settingsChange,this),this.settingsChange(),this.model.on("change:_dataset_info",this.datasetInfoChange,this),this.datasetInfoChange(),this.model.on("msg:custom",this.on_msg,this),this.viewId=this.model.nviews,++this.model.nviews},settingsChange:function(){this.settings=JSON.parse(this.model.get("_settings"))},datasetInfoChange:function(){this.datasetInfo=JSON.parse(this.model.get("_dataset_info"))},on_msg:function(e,t){"stream"==e?this.decodeAndDisplayVideo(t[0].buffer):console.log(e)},render:function(){var e=this;this.video=document.createElement("video"),this.intersectionObserver=new IntersectionObserver((function(t,i){e.onIntersecting(t,i)}),{}),this.intersectionObserver.observe(this.video),document.addEventListener("visibilitychange",(()=>{e.onVisibilityChange()})),this.video.addEventListener("pointermove",(function(t){e.onPointerMove(t)})),this.video.addEventListener("pointerdown",(function(t){e.onPointerDown(t)})),this.video.addEventListener("pointerup",(function(t){e.onPointerUp(t)})),this.video.addEventListener("pointercancel",(function(t){e.onPointerCancel(t)})),this.video.addEventListener("pointerout",(function(t){e.onPointerOut(t)})),this.video.addEventListener("wheel",(function(t){e.onWheel(t)}));var t=function(t){e.keyDownHandler(t)},i=function(t){e.keyUpHandler(t)},n=function(t){e.keyPressHandler(t)};if(this.video.addEventListener("focusin",(function(s){e.debug("add keyboard listeners"),document.addEventListener("keydown",t,!0),document.addEventListener("keyup",i,!0),document.addEventListener("keypress",n,!0)}),!1),this.video.addEventListener("focusout",(function(s){e.debug("remove keyboard listeners"),document.removeEventListener("keydown",t,!0),document.removeEventListener("keyup",i,!0),document.removeEventListener("keypress",n,!0)}),!1),this.video.autoplay=!0,this.video.muted=!0,this.video.setAttribute("width","auto"),this.video.setAttribute("height","auto"),this.el.appendChild(this.video),!window.MediaSource)return void e.debug("No Media Source API available");const s='video/mp4;codecs="avc1.64001F"';MediaSource.isTypeSupported(s)?(this.bufArray=new Array,this.streamOpen=!1,this.mediaSource=new MediaSource,this.video.src=window.URL.createObjectURL(this.mediaSource),this.video.load(),this.mediaSource.addEventListener("sourceopen",(function(){e.mediaSource.duration=1/0,e.sourceBuffer=e.mediaSource.addSourceBuffer(s),e.sourceBuffer.mode="sequence",e.streamOpen=!0,e.sourceBuffer.addEventListener("updateend",(()=>{e.decodeAndDisplayVideo(null)}))})),this.mediaSource.addEventListener("sourceclose",(function(){e.streamOpen=null})),this.mediaSource.addEventListener("sourceended",(function(){e.streamOpen=null}))):e.debug("codec not supported")},decodeAndDisplayVideo:function(e){if(null!==this.sourceBuffer){if(null!==e){const t=new Uint8Array(e.slice());this.bufArray.push(t)}if(this.streamOpen&&!this.sourceBuffer.updating&&this.bufArray.length>0){var t=this.bufArray.shift();const e=t.length;for(var i=t.length,n=!1;0!==t.length&&!this.sourceBuffer.updating;)try{this.sourceBuffer.appendBuffer(t.slice(0,i)),i=(t=t.slice(i)).length}catch(t){if("QuotaExceededError"!==t.name){n=!0;break}if((i=Math.ceil(.8*i))/e<.04){n=!0;break}}if(n){this.sourceBuffer.updating&&this.sourceBuffer.abort();const e=this.video.currentTime;e>2&&this.sourceBuffer.remove(0,e-2)}0!==t.length&&this.bufArray.unshift(t)}}},updateMultiTouch:function(){const e=this.touchedPoints[1].x-this.touchedPoints[0].x,t=this.touchedPoints[1].y-this.touchedPoints[0].y;this.multiTouchDistance=Math.sqrt(e*e+t*t),this.multiTouchCenter.x=this.touchedPoints[0].x+.5*e,this.multiTouchCenter.y=this.touchedPoints[0].y+.5*t},handleCameraUpdate:function(){var e={msg_type:"camera_update",contents:this.settings.Cameras};this.send(e)},handleDataViewUpdate:function(){var e={msg_type:"data_view_update",contents:this.settings.DataViews};this.send(e)},getScreenSize:function(){const e={screen_width_mm:1,screen_height_mm:1};if(void 0===this.settings.Views)return e;const t=this.settings.Views[0];if("TWOD"===t.mode){if(void 0===this.settings.DataViews||void 0===this.datasetInfo)return e;const i=this.settings.DataViews.find((e=>e.name===t.dataViewName));this.video.clientWidth>this.video.clientHeight?(e.screen_height_mm=this.datasetInfo.elementSize.y*this.datasetInfo.size.y/i.zoomFactor,e.screen_width_mm=e.screen_height_mm*(this.video.clientWidth/this.video.clientHeight)):(e.screen_width_mm=this.datasetInfo.elementSize.x*this.datasetInfo.size.x/i.zoomFactor,e.screen_height_mm=e.screen_width_mm*(this.video.clientHeight/this.video.clientWidth))}else if("SLICE"===t.mode||"SLICE_SEGMENTATION"===t.mode){if(void 0===this.settings.Cameras)return e;const i=this.settings.Cameras.find((e=>e.name===t.cameraName)),n=this.video.clientHeight/this.video.clientWidth,s=Math.tan(.5*i.fieldOfView*Math.PI/180);let o,a,d,r;n>1?(o=-s,d=s,a=-s*n,r=s*n):(o=-s/n,d=s/n,a=-s,r=s);const h=d-o,u=r-a,l=c(i.lookAt).sub(c(i.eye)),m=l.length();l.normalize();const f=c(i.up).cross(l);f.normalize();const v=l.clone().cross(f);v.normalize();const g=c(i.eye).add(f.clone().multiplyScalar(o)).add(v.clone().multiplyScalar(a)).add(l.clone().multiplyScalar(m)),p=c(i.eye).add(f.clone().multiplyScalar(o)).add(v.clone().multiplyScalar(a+u)).add(l.clone().multiplyScalar(m)),y=c(i.eye).add(f.clone().multiplyScalar(o+h)).add(v.clone().multiplyScalar(a)).add(l.clone().multiplyScalar(m));e.screen_width_mm=1e3*y.clone().sub(g).length(),e.screen_height_mm=1e3*p.clone().sub(g).length()}return e},pan:function(e,t){if(void 0===this.settings.Views)return;const i=this.settings.Views[0];if("TWOD"===i.mode){if(void 0===this.settings.DataViews)return;const{screen_width_mm:n,screen_height_mm:s}=this.getScreenSize(),o=this.settings.DataViews.find((e=>e.name===i.dataViewName));o.viewOffset.x-=e/this.video.clientWidth*n,o.viewOffset.y-=t/this.video.clientHeight*s,this.handleDataViewUpdate()}else{if(void 0===this.settings.Cameras)return;const h=this.settings.Cameras.find((e=>e.name===i.cameraName));var n,s=c(h.eye),o=c(h.lookAt),a=c(h.up),d=o.clone().sub(s),r=a.clone().cross(d);n="SLICE"===i.mode||"SLICE_SEGMENTATION"===i.mode?h.fieldOfView/30:d.length(),r.normalize();const u=n*(e/this.video.clientWidth),l=n*(-t/this.video.clientHeight);r.multiplyScalar(u);const m=a.clone().multiplyScalar(l);s.add(r).sub(m),o.add(r).sub(m),h.eye=Object.assign({},s),h.lookAt=Object.assign({},o),this.handleCameraUpdate()}},orbit:function(e,t){if(void 0===this.settings.Cameras||void 0===this.settings.Views)return;const i=this.settings.Views[0],n=this.settings.Cameras.find((e=>e.name===i.cameraName));var s=c(n.eye);const o=e/180*Math.PI,a=t/180*Math.PI,d=c(n.lookAt),r=c(n.up),u=c(n.up),l=s.clone().sub(d),m=r.clone().cross(l);h(l,m,a),h(l,u,o),h(r,m,a),h(r,u,o),s=l.clone().add(d),n.eye=Object.assign({},s),n.up=Object.assign({},r),this.handleCameraUpdate()},zoom:function(e){if(void 0===this.settings.Views)return;const t=this.settings.Views[0];if("TWOD"===t.mode){const i=this.settings.DataViews.find((e=>e.name===t.dataViewName));(e<1||i.zoomFactor>1)&&(i.zoomFactor=Math.max(i.zoomFactor/e,1),this.handleDataViewUpdate())}else{const n=this.settings.Cameras.find((e=>e.name===t.cameraName));if("CINEMATIC"===t.mode){var i=c(n.eye);i.sub(n.lookAt),(e>1||i.length()>5e-4)&&(i.multiplyScalar(e),i.add(n.lookAt),n.eye=Object.assign({},i),this.handleCameraUpdate())}else(e>1||n.fieldOfView>.1)&&(n.fieldOfView*=e,this.handleCameraUpdate())}},slice:function(e,t){if(void 0===this.settings.Views||void 0===this.datasetInfo)return;const i=this.settings.Views[0],n=this.settings.Cameras.find((e=>e.name===i.cameraName)),s=c(this.datasetInfo.elementSize).multiplyScalar(.001),a=c(this.datasetInfo.size).multiply(s),d=c(a).multiplyScalar(-.5),r=c(a).multiplyScalar(.5),h=c(n.eye).sub(n.lookAt).normalize(),u=c(h).multiply(a).multiplyScalar(t/this.video.clientHeight);var l=c(n.lookAt).add(u),m=c(n.eye).add(u);const f=c(d).sub(l).dot(h),v=new o.Vector3(d.x,d.y,r.z).sub(l).dot(h),g=new o.Vector3(d.x,r.y,d.z).sub(l).dot(h),p=new o.Vector3(d.x,r.y,r.z).sub(l).dot(h),y=new o.Vector3(r.x,d.y,d.z).sub(l).dot(h),w=new o.Vector3(r.x,d.y,r.z).sub(l).dot(h),_=new o.Vector3(r.x,r.y,d.z).sub(l).dot(h),b=c(r).sub(l).dot(h);Math.min(f,v,g,p,y,w,_,b)*Math.max(f,v,g,p,y,w,_,b)<0&&(n.lookAt=Object.assign({},l),n.eye=Object.assign({},m),this.handleCameraUpdate())},onIntersecting:function(e,t){e.forEach((e=>{e.target==this.video&&this.videoIsIntersecting!=e.isIntersecting&&(this.videoIsIntersecting=e.isIntersecting,this.onVisibilityChange())}))},onVisibilityChange(){try{var e={msg_type:"video_visible",contents:"visible"==document.visibilityState&&this.videoIsIntersecting};this.send(e)}catch(e){}},onPointerMove:function(e){const{clientX:t,clientY:i,shiftKey:n,pointerId:s}=e;if(2===this.touchedPoints.length){const e=this.multiTouchDistance,n=Object.assign({},this.multiTouchCenter);var o=this.touchedPoints.find((function(e){return e.pointerId===s}));void 0!==o&&(o.x=t,o.y=i,this.updateMultiTouch(),0!==this.multiTouchDistance&&this.zoom(e/this.multiTouchDistance),this.pan(this.multiTouchCenter.x-n.x,this.multiTouchCenter.y-n.y))}else if(1===this.touchedPoints.length){const e=t-this.touchedPoints[0].x,s=i-this.touchedPoints[0].y;if(1===this.button||0===this.button&&"a"===this.key)this.pan(e,s);else if(0===this.button&&void 0!==this.settings.Views){const t=this.settings.Views[0];"CINEMATIC"===t.mode||void 0!==t.cameraName&&t.cameraName.includes("Oblique")&&n?this.orbit(e,s):"TWOD"!==t.mode&&this.slice(e,s)}this.touchedPoints[0].x=t,this.touchedPoints[0].y=i}},onPointerDown:function(e){const{clientX:t,clientY:i,button:n,pointerId:s}=e;this.touchedPoints.push(new class{constructor(e,t,i){this.pointerId=e,this.x=t,this.y=i,this.start_x=t,this.start_y=i}}(s,t,i)),this.video.setPointerCapture(s),2===this.touchedPoints.length?updateMultiTouch():1===this.touchedPoints.length&&(this.button=n),e.preventDefault()},onPointerUp:function(e){const{button:t,pointerId:i}=e;this.video.releasePointerCapture(i);var n=this.touchedPoints.findIndex((function(e){return e.pointerId===i}));-1!==n&&this.touchedPoints.splice(n,1),2===this.touchedPoints.length?this.updateMultiTouch():1===this.touchedPoints.length?this.button=t:0===this.touchedPoints.length&&(e.stopPropagation(),e.preventDefault())},onWheel:function(e){const{deltaY:t}=e;this.zoom(t>0?1.05:.95),e.preventDefault(),e.stopPropagation(),this.video.focus({preventScroll:!0})},onPointerOut:function(e){const{pointerType:t}=e;"mouse"===t&&this.onPointerUp(e)},onPointerCancel:function(e){this.onPointerUp(e)},getKeyEventJson:function(e){return{key:e.key,keyCode:e.keyCode,which:e.which,charCode:e.charCode,char:String.fromCharCode(e.which),shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey}},keyDownHandler:function(e){var t={msg_type:"key_down",contents:this.getKeyEventJson(e)};t.key_down.x=0,t.key_down.y=0,this.send(t),e.stopPropagation()},keyPressHandler:function(e){var t={msg_type:"key_press",contents:this.getKeyEventJson(e)};t.key_press.x=0,t.key_press.y=0,this.send(t),e.stopPropagation()},keyUpHandler:function(e){var t={msg_type:"key_up",contents:this.getKeyEventJson(e)};t.key_up.x=0,t.key_up.y=0,this.send(t),e.stopPropagation()}});const c=e=>new o.Vector3(e.x,e.y,e.z),h=(e,t,i)=>{var n=Math.cos(i),s=Math.sin(i),o=t.clone();o.normalize();var a=e.dot(o),d=o.clone().multiplyScalar(a),r=e.clone().sub(d),c=r.clone().cross(o);r.multiplyScalar(n),c.multiplyScalar(s),d.add(r).add(c),e.x=d.x,e.y=d.y,e.z=d.z};e.exports={WidgetModel:d,WidgetView:r}},147:e=>{"use strict";e.exports={version:"0.4.2"}}}]);