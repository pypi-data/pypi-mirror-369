name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-homebrew-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew tap repository
        uses: actions/checkout@v4
        with:
          repository: adambirds/homebrew-pypi-package-updater
          token: ${{ secrets.PAT_TOKEN }}
          path: homebrew-tap
          
      - name: Update Homebrew Formula
        run: |
          # Remove 'v' prefix from tag for version
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}
          
          # Get PyPI package information
          PYPI_DATA=$(curl -s "https://pypi.org/pypi/pypi-package-updater/${VERSION}/json")
          PYPI_URL=$(echo "$PYPI_DATA" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for file in data['urls']:
              if file['filename'].endswith('.tar.gz'):
                  print(file['url'])
                  break
          ")
          PYPI_SHA256=$(echo "$PYPI_DATA" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for file in data['urls']:
              if file['filename'].endswith('.tar.gz'):
                  print(file['digests']['sha256'])
                  break
          ")
          
          echo "PyPI URL: $PYPI_URL"
          echo "PyPI SHA256: $PYPI_SHA256"
          
          # Update the formula file - only update the main package URL and SHA256
          sed -i "0,/url \".*\"/{s|url \".*\"|url \"$PYPI_URL\"|;}" homebrew-tap/Formula/pypi-package-updater.rb
          sed -i "0,/sha256 \".*\"/{s|sha256 \".*\"|sha256 \"$PYPI_SHA256\"|;}" homebrew-tap/Formula/pypi-package-updater.rb
          
      - name: Commit and Push Formula Updates
        run: |
          cd homebrew-tap
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Formula/pypi-package-updater.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Homebrew formula to ${{ github.ref_name }}"
            git push
          fi
