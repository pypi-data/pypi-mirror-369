Metadata-Version: 2.4
Name: clickhouse-migrations
Version: 0.9.1
Summary: Simple file-based migrations for clickhouse
Author-email: Aleh Strakachuk <zifter.ai+clickhouse.migrations@gmail.com>
License: MIT
Project-URL: Homepage, https://github.com/zifter/clickhouse-migrations
Project-URL: Source, https://github.com/zifter/clickhouse-migrations
Project-URL: Tracker, https://github.com/zifter/clickhouse-migrations/issues
Project-URL: Changelog, https://github.com/zifter/clickhouse-migrations/blob/main/CHANGELOG.md
Keywords: clickhouse,migrations
Classifier: Intended Audience :: Developers
Classifier: Programming Language :: Python
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Requires-Python: <4,>=3.9
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: clickhouse-driver>=0.2.2
Provides-Extra: testing
Requires-Dist: pytest==8.4.1; extra == "testing"
Requires-Dist: pytest-cov==6.2.1; extra == "testing"
Dynamic: license-file

[![ci](https://github.com/zifter/clickhouse-migrations/actions/workflows/ci.yaml/badge.svg)](https://github.com/zifter/clickhouse-migrations/actions/workflows/ci.yaml)
[![release](https://img.shields.io/github/release/zifter/clickhouse-migrations.svg)](https://github.com/zifter/clickhouse-migrations/releases)
[![PyPI version](https://badge.fury.io/py/clickhouse-migrations.svg)]([https://badge.fury.io/py/clickhouse-migrate](https://pypi.org/project/clickhouse-migrations/))
[![supported versions](https://img.shields.io/pypi/pyversions/clickhouse-migrations.svg)](https://pypi.org/project/clickhouse-migrations/)
[![downloads](https://img.shields.io/pypi/dm/clickhouse-migrations.svg)](https://pypi.org/project/clickhouse-migrations/)
[![my site](https://img.shields.io/badge/site-my%20blog-yellow.svg)](https://zifter.github.io/)

# Clickhouse Migrations

Python library for creating and applying migrations in ClickHouse database.

Development and Maintenance of large-scale db systems many times requires constant changes to the actual DB system.
Holding off the scripts to migrate these will be painful.

## Features:
* Supports multi statements - more than one query per migration file.
* Allow running migrations out-of-box
* Simple file migrations format: {VERSION}_{name}.sql
* Supports Cluster deployments, makes sure that migrations state is consistent on all cluster nodes

## Known alternatives
This package originally forked from [clickhouse-migrator](https://github.com/delium/clickhouse-migrator).

Package | Differences
-------|---------
[clickhouse-migrator](https://github.com/delium/clickhouse-migrator) | Doesn't support multistatement in a single file , to heavy because of pandas, looks like abandoned
[django-clickhouse](https://github.com/carrotquest/django-clickhouse) | Need django
[clickhouse-migrate](https://github.com/trushad0w/clickhouse-migrate) | Doesn't support multistatement

## Installation

You can install from pypi using `pip install clickhouse-migrations`.

## Usage

### In command line
```bash
clickhouse-migrations --db-host localhost \
    --db-user default \
    --db-password secret \
    --db-name test \
    --migrations-dir ./migrations
```

### In code
```python
from clickhouse_migrations.clickhouse_cluster import ClickhouseCluster

cluster = ClickhouseCluster(db_host, db_user, db_password)
cluster.migrate(db_name, migrations_home, cluster_name=None,create_db_if_no_exists=True, multi_statement=True)
```

Parameter | Description                                                                                         | Default
-------|-----------------------------------------------------------------------------------------------------|---------
db_host | Clickhouse database hostname                                                                        | localhost
db_port | Clickhouse database port                                                                            | 9000
db_user | Clickhouse user                                                                                     | default
db_password | Clichouse password                                                                                  | default
db_name| Clickhouse database name                                                                            | None
migration_path | Path to list of migration files                                                                     | <project_root>
migrations | Explicit list of migrations to apply                                                                | []
cluster_name | Name of Clickhouse topology cluster from <remote_servers>                                           | None
create_db_if_no_exists | If the `db_name` is not present, enabling this will create the db                                   | True
multi_statement | Allow multiple statements in migration files                                                        | True
secure | Use secure connection                                                                               | False
fake | Marks the migrations as applied but without actually running the SQL to change your database schema | False

### Notes
The Clickhouse driver does not natively support executing multipe statements in a single query.
To allow for multiple statements in a single migration, you can use the multi_statement param.
There are two important caveats:
* This mode splits the migration text into separately-executed statements by a semi-colon ;. Thus cannot be used when a statement in the migration contains a string with a semi-colon.
* The queries are not executed in any sort of transaction/batch, meaning you are responsible for fixing partial migrations.
