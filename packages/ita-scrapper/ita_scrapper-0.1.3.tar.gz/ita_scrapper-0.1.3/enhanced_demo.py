#!/usr/bin/env python3
"""
Enhanced example showcasing the improved flight data parsing capabilities.
"""

import asyncio
import logging
from datetime import date, timedelta
from decimal import Decimal

from ita_scrapper import ITAScrapper
from ita_scrapper.models import CabinClass, TripType
from ita_scrapper.exceptions import ITAScrapperError

# Configure logging
logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


async def enhanced_flight_search_demo():
    """Demonstrate enhanced flight search capabilities."""
    print("‚úàÔ∏è  Enhanced Flight Data Parsing Demo")
    print("=" * 60)

    try:
        # Use ITA Matrix for better data quality
        async with ITAScrapper(
            headless=False,  # Show browser to see the parsing in action
            use_matrix=True,
            timeout=60000,
        ) as scrapper:
            print("üîç Searching for flights with enhanced parsing...")

            # Search for flights with detailed parsing
            departure_date = date.today() + timedelta(days=30)
            return_date = departure_date + timedelta(days=7)

            result = await scrapper.search_flights(
                origin="JFK",
                destination="LHR",
                departure_date=departure_date,
                return_date=return_date,
                cabin_class=CabinClass.ECONOMY,
                adults=1,
                max_results=3,
            )

            print(f"\n‚úÖ Found {len(result.flights)} flights")
            print(
                f"üõ´ Route: {result.search_params.origin} ‚Üí {result.search_params.destination}"
            )
            print(f"üìÖ Departure: {result.search_params.departure_date}")
            print(f"üìÖ Return: {result.search_params.return_date}")

            if result.flights:
                print("\n" + "=" * 60)
                print("üìä DETAILED FLIGHT ANALYSIS")
                print("=" * 60)

                # Show detailed flight information
                for i, flight in enumerate(result.flights, 1):
                    print(f"\n‚úàÔ∏è  FLIGHT {i}")
                    print("-" * 30)
                    print(f"üí∞ Price: ${flight.price}")
                    print(
                        f"‚è±Ô∏è  Total Duration: {flight.total_duration_minutes // 60}h {flight.total_duration_minutes % 60}m"
                    )
                    print(f"üîÑ Stops: {flight.stops}")
                    print(f"üè¢ Airlines: {', '.join(flight.airlines)}")
                    print(f"üé´ Cabin Class: {flight.cabin_class.value}")
                    print(f"üíº Refundable: {'Yes' if flight.is_refundable else 'No'}")
                    print(
                        f"üéí Baggage Included: {'Yes' if flight.baggage_included else 'No'}"
                    )

                    # Show detailed segment information
                    print(
                        f"\nüìç FLIGHT SEGMENTS ({len(flight.segments)} segment{'s' if len(flight.segments) != 1 else ''}):"
                    )
                    for j, segment in enumerate(flight.segments, 1):
                        print(
                            f"  Segment {j}: {segment.departure_airport.code} ‚Üí {segment.arrival_airport.code}"
                        )
                        print(
                            f"    üè¢ Airline: {segment.airline.name} ({segment.airline.code})"
                        )
                        print(f"    üé´ Flight: {segment.flight_number}")
                        print(
                            f"    üõ´ Departure: {segment.departure_time.strftime('%I:%M %p on %b %d')}"
                        )
                        print(
                            f"    üõ¨ Arrival: {segment.arrival_time.strftime('%I:%M %p on %b %d')}"
                        )
                        print(
                            f"    ‚è±Ô∏è  Duration: {segment.duration_minutes // 60}h {segment.duration_minutes % 60}m"
                        )
                        if segment.stops > 0:
                            print(f"    üîÑ Stops: {segment.stops}")
                        if segment.aircraft_type:
                            print(f"    ‚úàÔ∏è  Aircraft: {segment.aircraft_type}")

                # Flight comparison analysis
                print(f"\n" + "=" * 60)
                print("üìà FLIGHT COMPARISON")
                print("=" * 60)

                if result.cheapest_flight:
                    cheapest = result.cheapest_flight
                    print(f"üí∞ CHEAPEST: ${cheapest.price}")
                    print(
                        f"   Duration: {cheapest.total_duration_minutes // 60}h {cheapest.total_duration_minutes % 60}m"
                    )
                    print(f"   Airlines: {', '.join(cheapest.airlines)}")
                    print(f"   Stops: {cheapest.stops}")

                if result.fastest_flight:
                    fastest = result.fastest_flight
                    print(
                        f"‚ö° FASTEST: {fastest.total_duration_minutes // 60}h {fastest.total_duration_minutes % 60}m"
                    )
                    print(f"   Price: ${fastest.price}")
                    print(f"   Airlines: {', '.join(fastest.airlines)}")
                    print(f"   Stops: {fastest.stops}")

                # Price analysis
                prices = [float(f.price) for f in result.flights]
                avg_price = sum(prices) / len(prices)
                min_price = min(prices)
                max_price = max(prices)

                print(f"\nüí∞ PRICE ANALYSIS:")
                print(f"   Average: ${avg_price:.2f}")
                print(f"   Range: ${min_price:.2f} - ${max_price:.2f}")
                print(f"   Savings: ${max_price - min_price:.2f} (choosing cheapest)")

                # Duration analysis
                durations = [f.total_duration_minutes for f in result.flights]
                avg_duration = sum(durations) / len(durations)
                min_duration = min(durations)
                max_duration = max(durations)

                print(f"\n‚è±Ô∏è  DURATION ANALYSIS:")
                print(f"   Average: {avg_duration // 60:.0f}h {avg_duration % 60:.0f}m")
                print(
                    f"   Range: {min_duration // 60}h {min_duration % 60}m - {max_duration // 60}h {max_duration % 60}m"
                )
                print(
                    f"   Time saved: {(max_duration - min_duration) // 60}h {(max_duration - min_duration) % 60}m (choosing fastest)"
                )

                # Airlines analysis
                all_airlines = set()
                for flight in result.flights:
                    all_airlines.update(flight.airlines)

                print(f"\nüè¢ AIRLINES FOUND:")
                print(f"   {', '.join(sorted(all_airlines))}")

            else:
                print("‚ùå No flights found")
                print("This might indicate:")
                print("‚Ä¢ No flights available for the selected dates")
                print("‚Ä¢ Parsing issues with the current page structure")
                print("‚Ä¢ Anti-bot measures blocking the search")

    except ITAScrapperError as e:
        logger.error(f"Scrapper error: {e}")
        print(f"‚ùå Scraper error: {e}")
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        print(f"‚ùå Unexpected error: {e}")


async def compare_parsing_methods():
    """Compare the enhanced parsing with basic parsing."""
    print("\n" + "=" * 60)
    print("üî¨ PARSING METHOD COMPARISON")
    print("=" * 60)

    try:
        # Test both ITA Matrix and Google Flights
        routes = [
            ("JFK", "LAX", "JFK to LAX (Domestic)"),
            ("NYC", "LON", "NYC to London (International)"),
        ]

        for origin, dest, description in routes:
            print(f"\nüõ£Ô∏è  Testing route: {description}")
            print("-" * 40)

            departure_date = date.today() + timedelta(days=45)

            # Test ITA Matrix (enhanced parsing)
            try:
                async with ITAScrapper(
                    headless=True, use_matrix=True, timeout=45000
                ) as scrapper:
                    result_ita = await scrapper.search_flights(
                        origin=origin,
                        destination=dest,
                        departure_date=departure_date,
                        cabin_class=CabinClass.ECONOMY,
                        adults=1,
                        max_results=2,
                    )

                    print(f"‚úÖ ITA Matrix: {len(result_ita.flights)} flights found")
                    if result_ita.flights:
                        ita_cheapest = result_ita.cheapest_flight.price
                        print(f"   üí∞ Cheapest: ${ita_cheapest}")
                        print(
                            f"   üè¢ Airlines: {', '.join(result_ita.flights[0].airlines)}"
                        )

            except Exception as e:
                print(f"‚ùå ITA Matrix failed: {e}")

            # Test Google Flights (basic parsing)
            try:
                async with ITAScrapper(
                    headless=True, use_matrix=False, timeout=45000
                ) as scrapper:
                    result_google = await scrapper.search_flights(
                        origin=origin,
                        destination=dest,
                        departure_date=departure_date,
                        cabin_class=CabinClass.ECONOMY,
                        adults=1,
                        max_results=2,
                    )

                    print(
                        f"‚úÖ Google Flights: {len(result_google.flights)} flights found"
                    )
                    if result_google.flights:
                        google_cheapest = result_google.cheapest_flight.price
                        print(f"   üí∞ Cheapest: ${google_cheapest}")
                        print(
                            f"   üè¢ Airlines: {', '.join(result_google.flights[0].airlines)}"
                        )

            except Exception as e:
                print(f"‚ùå Google Flights failed: {e}")

    except Exception as e:
        print(f"‚ùå Comparison failed: {e}")


async def main():
    """Run the enhanced flight search demo."""
    await enhanced_flight_search_demo()

    # Ask user if they want to compare parsing methods
    print(f"\n{'=' * 60}")
    user_input = input(
        "üîÑ Do you want to compare ITA Matrix vs Google Flights parsing? (y/N): "
    )
    if user_input.lower() in ["y", "yes"]:
        await compare_parsing_methods()

    print(f"\n{'=' * 60}")
    print("üéâ Enhanced flight data parsing demo completed!")
    print("üí° Key improvements demonstrated:")
    print("   ‚Ä¢ Better price extraction from tooltips")
    print("   ‚Ä¢ Enhanced airline identification")
    print("   ‚Ä¢ Detailed flight segment information")
    print("   ‚Ä¢ Comprehensive flight analysis")
    print("   ‚Ä¢ Robust error handling")


if __name__ == "__main__":
    asyncio.run(main())
