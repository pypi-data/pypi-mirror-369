import{r as i,Q as U,U as q,x as _,L as G,y as W,az as X,aA as Y,a as I,j as s,z as Z,B as n,K as L,H as ss,P as S}from"./index-7AvwSwCy.js";import{P as es,r as as}from"./index-C8gVfalV.js";import{A as is}from"./index-4-7uQlQF.js";import{C as ls}from"./index-CS88LIE_.js";import{F as ns,S as ts}from"./Table-BNMDHWhP.js";import{T as rs}from"./index-CXNer6h3.js";var os={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},cs=function(j,g){return i.createElement(U,q({},j,{ref:g,icon:os}))},ds=i.forwardRef(cs);const Ss=i.forwardRef(({title:b,form:j,appendSampleColumns:g=[],setResultTableList:v,cleanDom:ms,analysisType:us,setRecord:k,setTableLoading:ps,setTabletData:ys,shouldTrigger:fs,columnsParamsALL:xs,project:E,software:hs,component_id:M,component_ids:B,operatePipeline:_s,editParams:w},T)=>{i.useImperativeHandle(T,()=>({reload:t}));const[m,F]=i.useState(),[js,P]=_.useMessage(),{modal:l,openModal:u,closeModal:c}=G(),[gs,vs]=i.useState(!1),O=W(),D=X(),{eventSourceRef:d,status:ks,reconnect:ws}=Y(),[r,H]=i.useState([]),p=i.useRef([]),y=i.useRef(null),f=i.useRef(null),[$,C]=i.useState(!1),[K,N]=i.useState();i.useEffect(()=>{if(r&&Array.isArray(r)&&r.length>0&&l.visible&&l.params){const a=r.find(e=>e.analysis_id==l.params.analysis_id);a&&N(a)}},[r,l.params]),i.useEffect(()=>{var a;if(d){const e=o=>{var A,R;const h=JSON.parse(o.data);console.log("analysisId",p.current),p.current.includes(h.analysis_id)&&(h.event=="analysis_complete"||h.event=="analysis_failed")&&(t(),y.current&&((A=y.current)==null||A.relaod()),f.current&&((R=f.current)==null||R.relaod()))};return(a=d.current)==null||a.addEventListener("message",e),()=>{var o;console.log("removeEventListener"),(o=d.current)==null||o.removeEventListener("message",e)}}},[d.current]);const x=a=>{k&&k(a),F(a)},t=async()=>{C(!0);let a=await I.post("/list-analysis",{component_id:M,component_ids:B,project:E});v&&v(a.data),H(a.data);const e=a.data.map(o=>o.analysis_id);p.current=e,C(!1)},V=async a=>{await I.delete(`/fast-api/analysis/${a}`),_.success("删除成功!"),t()},z=(a,e)=>l.params?a.analysis_id==l.params.analysis_id&&e==l.key:!1,J=async a=>{await as(a.analysis_id),_.success("运行成功"),t()};let Q=[{title:"project_name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(a,e)=>s.jsx(L,{title:e.project,children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"analysis_status",dataIndex:"analysis_status",key:"analysis_status",ellipsis:!0,render:a=>s.jsx(rs,{color:a==="success"?"green":a==="failed"?"red":"blue",children:a})},{title:"analysis_id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(a,e)=>s.jsx(ss,{title:s.jsx(s.Fragment,{children:s.jsxs("ul",{children:[s.jsxs("li",{children:["analysis_name:",e.analysis_name]}),s.jsxs("li",{children:["pipeline_script:",e.pipeline_script]}),s.jsxs("li",{children:["work_dir:",e.work_dir]}),s.jsxs("li",{children:["output_dir:",e.output_dir]}),s.jsxs("li",{children:["command_log_path:",e.command_log_path]}),s.jsxs("li",{children:["trace_file:",e.trace_file]}),s.jsxs("li",{children:["executor_log_file:",e.executor_log_file]}),s.jsxs("li",{children:["workflow_log_file:",e.workflow_log_file]})]})}),children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"组件名称",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(a,e)=>s.jsx(L,{title:e.component_id,children:s.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"分析名称",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"image",dataIndex:"image",key:"image",ellipsis:!0},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(a,e)=>s.jsxs(ts,{size:"middle",children:[s.jsx(n,{size:"small",color:"cyan",variant:"solid",onClick:()=>{O(`/software-analysis-editor/${e.analysis_id}`,{state:{location:D.pathname}})},children:"编辑"}),s.jsx(S,{title:"是否运行!",onConfirm:()=>{J(e),u("modalA",e),x(e)},children:s.jsx(n,{disabled:e.analysis_status=="running",size:"small",color:"cyan",variant:"solid",children:e.analysis_status=="created"?"运行":"重新运行"})}),w&&s.jsx(n,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(e),children:"编辑参数"}),z(e,"modalA")?s.jsx(n,{size:"small",color:"cyan",variant:"solid",onClick:()=>{c()},children:"关闭"}):s.jsx(n,{size:"small",color:"cyan",variant:"solid",onClick:()=>{u("modalA",e),x(e)},children:"查看结果"}),z(e,"modalB")?s.jsx(n,{size:"small",color:"cyan",variant:"solid",onClick:()=>{c()},children:"关闭"}):s.jsx(n,{size:"small",color:"cyan",variant:"solid",onClick:()=>{u("modalB",e),x(e)},children:"详情"}),s.jsx(S,{title:"是否删除!",onConfirm:async()=>{await V(e.id),t()},children:s.jsx(n,{size:"small",color:"danger",variant:"solid",children:"删除"})})]})}];return i.useEffect(()=>{t()},[]),s.jsxs(s.Fragment,{children:[P,s.jsx(ls,{size:"small",title:s.jsxs(s.Fragment,{children:[s.jsx(ds,{})," 分析记录"]}),extra:s.jsx(Z,{gap:"small",children:s.jsx(n,{size:"small",type:"primary",onClick:t,children:"刷新"})}),children:s.jsx(ns,{rowKey:"analysis_id",size:"small",bordered:!0,pagination:!1,loading:$,scroll:{x:"max-content",y:55*5},columns:Q,footer:()=>`一共${r.length}条记录`,dataSource:r})}),s.jsx("div",{style:{marginBottom:"1rem"}}),s.jsx(is,{ref:y,visible:l.key=="modalA"&&l.visible,params:l.params,currentAnalysis:K,status:m==null?void 0:m.analysis_status,onClose:c}),s.jsx(es,{ref:f,visible:l.key=="modalB"&&l.visible,params:l.params,onClose:c,callback:t})]})});export{Ss as R};
