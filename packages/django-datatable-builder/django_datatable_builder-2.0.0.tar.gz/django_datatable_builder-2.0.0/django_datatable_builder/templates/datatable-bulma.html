{% load datatable_tags %}
{% load static %}

{% comment %} <link href="{% static 'DataTable-css/datatables-sin.css' %}" rel="stylesheet"> {% endcomment %}

{% comment %} <link href="{% static 'bulma/css/bulma.css' %}" rel="stylesheet" > {% endcomment %}
{% comment %} <link href="{% static 'bulma/css/bulma-no-dark.css' %}" rel="stylesheet" > {% endcomment %}
{% comment %} <link href="{% static 'bulma/css/bulma-custom.css' %}" rel="stylesheet" > {% endcomment %}
{% comment %} <link href="{% static 'DataTables-sin-bulma/datatables.css' %}" rel="stylesheet"> {% endcomment %}

{% comment %} <link href="{% static 'DataTables-con-bulma/datatables.css' %}" rel="stylesheet"> {% endcomment %}
<link href="{% static 'bootstrap/css/bootstrap.css' %}" rel="stylesheet">
{% comment %} <script src="{% static 'bootstrap/js/bootstrap.js'%}"></script> {% endcomment %}


<!-- htmx -->
<script src="{% static 'htmx/htmx.min.js' %}"></script>

<script src="{% static 'datatables/datatables.js'%}"></script>
<script src="{% static 'DataTables-sin/datatables.js' %}"></script>

<div class="container">
<div class="table-responsive">
    <table id="{{ table_id }}" class="table card-table table-vcenter text-nowrap datatable table-striped" style="width:100%" data-bs-theme="light" >

    {% comment %} <table id="{{ table_id }}" class="table is-striped is-hoverable"> {% endcomment %}
        <thead>
            <tr>
                {% if columns %}
                    {% for column in columns %}
                        <th data-priority="2">{{ column|underscore_to_space }}</th>
                    {% endfor %}
                    {% if columns_extra %}
                        {% for column in columns_extra %}
                            <th data-priority="3">{{ column|underscore_to_space }}</th>
                        {% endfor %}
                    {% endif %}
                    {% if button_url %}
                        <th data-priority="1"></th>
                    {% endif %}
                {% else %}
                    <th><h6>No hay columnas</h6></th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for datos in data %}
                <tr>
                    {% for column in columns %}
                        {% if column not in hidden %}
                            <td class="is-family-primary">{{ datos|get_item:column|default_if_none:"-Sin Datos-" }}</td>
                        {% endif %}
                    {% endfor %}
                    {% if columns_extra %}
                        {% for column in columns_extra %}
                           <td class="is-family-primary">{{ datos|get_item:column|default_if_none:"-Sin Datos-" }}</td>
                        {% endfor %}
                    {% endif %}

                    {% if button_url %}
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                {% if button_dropdown %}
                                    <div class="dropdown">
                                        <a href="#" class="btn btn-primary float-end dropdown-toggle" data-bs-toggle="dropdown"><i class="ti ti-dots-vertical"></i>Acciones</a>
                                        <div class="dropdown-menu">
                                            {% for title, elements in button_url.items %}
                                                {% for type, url_data in elements.items %}
                                                    {% if type == "modal" %}
                                                        <a class="dropdown-item" hx-get="{% dt_reverse url_data.url url_data.params datos %}" hx-target='#content_modal' hx-trigger='click' data-bs-toggle='modal' data-bs-target='#general_modal'>{{ title }}</a>
                                                    {% elif type == "link" %}
                                                        <a class="dropdown-item" href="{% dt_reverse url_data.url url_data.params datos %}">{{ title }}</a>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% else %}
                                    {% for title, elements in button_url.items %}
                                        {% for type, url_data in elements.items %}
                                            {% if type == "modal" %}
                                                <button hx-get="{% dt_reverse url_data.url url_data.params datos %}" hx-target="#content_modal" hx-trigger="click" data-bs-toggle="modal" data-bs-target="#general_modal" class="btn {% if elements.class %} {{ elements.class }} {% else %} btn btn-secondary float-end {% endif %} mx-1">
                                                    {{ title }}
                                                </button>
                                            {% elif type == "link" %}
                                                <a class="btn {% if elements.class %} {{ elements.class }} {% else %} btn btn-secondary float-end {% endif %} mx-1" href="{% dt_reverse url_data.url url_data.params datos %}">{{ title }}</a>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endif %}
                                {% if button_inline %}
                                    {% for title, elements in button_inline.items %}
                                        {% for type, url_data in elements.items %}
                                            {% if type == "link" %}
                                                <a class="btn {% if elements.class %} {{ elements.class }} {% else %} btn btn-secondary float-end {% endif %} mx-1" href="{% dt_reverse url_data.url url_data.params datos %}" title="{{ title }}">{{ title }}</a>
                                            {% elif type == "modal" %}
                                                <a class="btn {% if elements.class %} {{ elements.class }} {% else %} btn btn-secondary float-end {% endif %} mx-1" hx-get="{% dt_reverse url_data.url url_data.params datos %}" hx-target='#modal-content' hx-trigger='click' data-bs-toggle='modal-remote' data-bs-target='#modal-remote'>{{ title }}</a>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<div id="general_modal" class="custom-modal" aria-hidden="false" tabindex="-1">
    <div class="custom-modal-background">
        <div class="custom-modal-content" id="content_modal"></div>
    </div>
</div>
<script>
    document.getElementById('general_modal').addEventListener('show.bs.modal', function (event) {
        document.getElementById('content_modal').innerHTML = '';
    });
</script>
<script>
    var table_id = "{{ table_id }}";
    $(document).ready(function () {
        var table = $('#'+table_id).DataTable({
            responsive: true,
            paging: true,
            order: {{ order|safe }},
            language: {
                "decimal": "",
                "emptyTable": "No hay datos disponibles",
                "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "infoEmpty": "",
                "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                "infoPostFix": "",
                "thousands": ",",
                "lengthMenu": "Mostrando _MENU_",
                "loadingRecords": "Cargando...",
                "processing": "",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros",
            },
            {% if column_search %}
                initComplete: function () {
                    var api = this.api();

                    var cantidad_columnas = parseInt("{{ columns|length }}") + parseInt("{{ columns_extra|length }}");
                    var columnas_search = Array.from({ length: cantidad_columnas }, (_, i) => i);

                    var searchRow = $('<tr class="search-row"></tr>').appendTo($(api.table().header()));
                    var searchInputs = [];
                    
                    api.columns().every(function (index, column) {
                        var column = this;
                        var title = $(column.header()).text();
                        var th = $('<th></th>').appendTo(searchRow);

                        if (columnas_search.includes(index)) {
                            var input = $('<input type="text" class="input" placeholder="Buscar ' + title + '" />')
                                .appendTo(th)
                                .on('keyup change clear', function () {
                                    if (column.search() !== this.value) {
                                        column.search(this.value).draw();
                                    }
                                });
                            searchInputs.push({ index: index, input: input, th: th });
                        }else{
                            searchInputs.push({ index: index, input: null, th: th });
                        }
                    });
                    api.on('responsive-resize', function (e, datatable, columnsVisible) {
                        searchInputs.forEach(function (item, i) {
                            if (columnsVisible[i]) {
                                item.th.show();
                            } else {
                                item.th.hide();
                            }
                        });
                    });
                }
            {% endif %}
        });
    });
</script>
