<!DOCTYPE html>
<html class="scroll-smooth" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{report_name}}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4.1.10"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/base16/one-light.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/languages/json.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <script>
      const records = {{ records_json | safe }};

      document.addEventListener("alpine:init", () => {
        Alpine.data("app", () => ({
          expandedSections: {},
          selectedRecordId: records.length > 0 ? records[0].id : null,
          selectedImage: null,
          searchQuery: "",
          statusQuery: "",
          records,
          formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
              hour: "numeric",
              minute: "2-digit",
              second: "2-digit",
              hour12: true,
            });
          },
          formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
          },
          get selectedRecord() {
            return this.records.find(
              (record) => record.id === this.selectedRecordId
            );
          },
          get filteredRecords() {
            if (!this.searchQuery && !this.statusQuery) return this.records;
            const query = this.searchQuery.toLowerCase();
            const statusQuery = this.statusQuery.toLowerCase();
            return this.records.filter((record) =>{
              if (this.searchQuery) {
                if (!record.id.toLowerCase().includes(query)) return false;
              }

              if (this.statusQuery) {
                if (this.statusQuery === '---') {
                  if (((record.status || '').trim().length) !== 0) return false;
                } else {
                  if (!(record.status || '').toLowerCase().includes(statusQuery)) return false;
                }
              }

              return true;
            });
          },
          get statusCounts() {
            return this.records.reduce((counts, record) => {
              counts[record.status] = (counts[record.status] || 0) + 1;
              return counts;
            }, {});
          },
          get statuses(){
            const statusSet = new Set();
            this.records.forEach(record => statusSet.add(record.status));
            return Array.from(statusSet);
          },
          get statusColors(){
            return this.records.reduce((colors, record) => {
              colors[record.status] = record.statusColor;
              return colors;
            }, {});
          }
        }));
      });
    </script>

    <style type="text/tailwindcss">
      @theme {
        --color-primary: rgb(255, 59, 72);
        --color-border: oklch(0.872 0 0);
        --font-sans: "Inter", ui-sans-serif, system-ui, -apple-system,
          BlinkMacSystemFont;
        --ta-background: linear-gradient(
              135deg,
              rgb(255, 158, 0) 0%,
              rgb(255, 59, 72) 35%,
              rgb(229, 42, 113) 68%,
              rgb(165, 0, 221) 100%
            )
            padding-box padding-box,
          linear-gradient(rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15)),
          linear-gradient(
              135deg,
              rgb(255, 158, 0) 0%,
              rgb(255, 59, 72) 35%,
              rgb(229, 42, 113) 68%,
              rgb(165, 0, 221) 100%
            )
            border-box border-box;
      }

      @layer base {
        * {
          @apply border-border;
        }
      }
    </style>
  </head>
  <body class="flex h-screen flex-col" x-data="app">
    <header class="flex items-center gap-x-4 border-b px-5 py-4">
      <div class="flex items-center gap-x-2">
        <div class="h-6 w-6">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            id="ThoughtfulAutomationMarkSVG"
            data-name="Layer 1"
            viewBox="0 0 86.7105 86.7106"
          >
            <defs>
              <linearGradient
                id="linear-gradient"
                x1="-4.0039"
                y1="24.6196"
                x2="64.8439"
                y2="93.4674"
                gradientUnits="userSpaceOnUse"
              >
                <stop offset="0" stop-color="#ff9e00" />
                <stop offset="0.5" stop-color="#ff3b48" />
                <stop offset="1" stop-color="#a500dd" />
              </linearGradient>
              <linearGradient
                id="linear-gradient-2"
                x1="8.2211"
                y1="8.2212"
                x2="78.4811"
                y2="78.4812"
                xlink:href="#linear-gradient"
              />
            </defs>
            <g id="logoMark">
              <path
                id="logoMark_path1"
                data-name="logoMark &lt;PathItem&gt;"
                d="M69.2076,85.279,43.1763,59.2477,17.145,85.279a3.6659,3.6659,0,0,1-5.1843,0L1.0737,74.392a3.6659,3.6659,0,0,1,0-5.1843l20.83-20.83a30.2016,30.2016,0,0,1,21.2254-8.9733,29.5,29.5,0,0,1,21.044,8.6972l21.106,21.1061a3.6659,3.6659,0,0,1,0,5.1843L74.3919,85.279A3.6659,3.6659,0,0,1,69.2076,85.279Z"
                style="fill: url(#linear-gradient)"
              />
              <path
                id="logoMark_path2"
                data-name="logoMark &lt;PathItem&gt;"
                d="M27.8088,43.88,1.0737,17.1453a3.6659,3.6659,0,0,1,0-5.1843L11.9607,1.0737a3.666,3.666,0,0,1,5.1844,0L41.288,25.2166a3.666,3.666,0,0,1,0,5.1844Z"
                style="fill: url(#linear-gradient-2)"
              />
            </g>
          </svg>
        </div>
        <span class="text-[1.375rem] font-bold text-gray-700">thoughtful</span>
        <div class="px-5 flex flex-col">
          <div class="text-[1.375rem] font-bold text-gray-700">
            {{report_name}}
          </div>
          <span
            >Report generated for run on {{report_date}}
            <a
              href="{{run_link}}"
              target="_blank"
              class="text-blue-500 underline"
            >
              [run link]
            </a>
          </span>
        </div>
      </div>
    </header>

    <nav x-show="false" class="border-b px-5 shadow-sm">
      <div class="flex gap-x-5">
        <div class="relative py-4">Overview</div>
        <div
          class="relative py-4 after:absolute after:-left-[10%] after:bottom-0 after:h-[0.175rem] after:w-[120%] after:[background:var(--ta-background)]"
        >
          Records
        </div>
      </div>
    </nav>

    <div
      class="grid gap-5 border-b p-5 overflow-x-auto"
      style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr))"
    >
      <div
        @click="statusQuery = ''"
        class="transition transform hover:-translate-y-2 col-span-1 flex h-full flex-col items-center justify-center gap-y-4 rounded-md border-2 border-gray-400 p-6 shadow-sm"
      >
        <span
          class="text-5xl font-bold"
          x-text="Object.values(statusCounts).reduce((a, b) => a + b, 0)"
        ></span>
        <span class="font-semibold uppercase text-gray-400">Total</span>
      </div>
      <template x-for="(count, status) in statusCounts" :key="status">
        <div
          class="transition transform hover:-translate-y-2 col-span-1 flex h-full flex-col items-center justify-center gap-y-4 rounded-md border-2 p-6 shadow-sm"
          :style="statusColors && statusColors[status] ? 'border-color: ' + statusColors[status] : ''"
          @click="statusQuery = status.length ? status : '---'"
        >
          <span class="text-5xl font-bold" x-text="count"></span>
          <span
            class="font-semibold uppercase text-gray-400"
            x-text="status || '---'"
          ></span>
        </div>
      </template>
    </div>

    <div class="flex w-full items-center gap-x-5 border-b p-5">
      <div class="relative w-1/4">
        <div
          class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-gray-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </div>
        <input
          type="text"
          x-model="searchQuery"
          placeholder="Search by ID..."
          class="focus:ring-primary w-full rounded-md border bg-white py-2 pl-10 pr-4 shadow focus:outline-none focus:ring-1"
        />
      </div>
      <div class="w-1/4">
        <select
          type="text"
          x-if="statuses.length > 0"
          x-model="statusQuery"
          placeholder="Search by Status..."
          class="focus:ring-primary w-full rounded-md border bg-white py-2 pl-10 pr-4 shadow focus:outline-none focus:ring-1"
        >
          <option value="">All</option>
          <template
            x-if="status.length > 0"
            x-for="status in statuses"
            :key="status"
          >
            <option :value="status" x-text="status || '---'"></option>
          </template>
        </select>
      </div>
    </div>

    <div
      x-show="selectedImage"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/70"
      @click.self="selectedImage = null"
    >
      <div class="relative max-h-[90vh] max-w-[90vw]">
        <img
          :src="selectedImage"
          alt="Maximized image"
          class="max-h-[90vh] max-w-[90vw] rounded-lg object-contain"
        />
        <button
          @click="selectedImage = null"
          class="absolute -right-4 -top-4 flex h-8 w-8 items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-100"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 text-gray-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
      <div
        class="h-full w-2/5 overflow-y-auto scroll-smooth border-r"
        x-data="{ width: 'auto', setWidth() { this.$nextTick(() => { let max = 0; document.querySelectorAll('.status-cell').forEach(el => { max = Math.max(max, el.offsetWidth); }); this.width = max + 'px'; document.documentElement.style.setProperty('--status-col-width', this.width); }); } }"
        x-init="setWidth()"
        @records-updated.window="setWidth()"
      >
        <template x-for="record in filteredRecords" :key="record.id">
          <div
            class="relative grid cursor-pointer items-center text-ellipsis border-b p-5 hover:bg-gray-100"
            :style="'grid-template-columns: 1fr var(--status-col-width,auto);'"
            :class="{ 'bg-gray-500/20 before:absolute before before:w-1 before:h-full before:right-0 before:top-0 before:[background:var(--ta-background)]': record.id === selectedRecordId }"
            @click="
              selectedRecordId = record.id;
              $nextTick(() => {
                $refs.recordTraces.scrollTop = 0;
                hljs.highlightAll();
              })
            "
          >
            <div class="flex items-center gap-x-4">
              <div x-text="record.id" class="text-sm"></div>
            </div>
            <div class="flex items-center gap-x-2 status-cell">
              <div
                x-show="record.status"
                class="h-2 w-2 rounded-full"
                :style="{ backgroundColor: record.statusColor }"
              ></div>
              <span
                x-show="record.status"
                x-text="record.status"
                class="text-sm text-gray-600 text-left"
              ></span>
              <span
                x-show="!record.status.length"
                class="-ml-2 w-full h-0.25 border border-gray-300"
              >
              </span>
            </div>
            <div
              x-show="false"
              x-text="record.time"
              class="text-sm text-gray-400"
            ></div>
          </div>
        </template>
      </div>

      <div class="h-full w-3/5 overflow-y-auto p-5" x-ref="recordTraces">
        <div class="">
          <h3 class="mb-6 text-lg font-medium">Record Traces</h3>

          <div class="relative">
            <div
              class="bg-border absolute bottom-0 left-4 top-6 z-0 w-0.5"
            ></div>

            <template
              x-for="(event, index) in selectedRecord.events.map((event, index) => ({...event, key: selectedRecordId+index}))"
              :key="event.key"
            >
              <div class="relative mb-10">
                <div
                  class="absolute left-0 top-0 z-10 flex h-8 w-8 items-center justify-center rounded-full bg-gray-300"
                >
                  <svg
                    x-show="false"
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 text-gray-500"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                </div>

                <div
                  x-show="event.type === 'trace'"
                  class="ml-12 flex flex-col gap-y-2"
                >
                  <div class="flex items-center">
                    <h4 class="text-lg font-medium" x-text="event.action"></h4>
                    <span
                      class="ml-3 text-sm text-gray-400"
                      x-text="formatDate(event.timestamp)"
                    ></span>
                  </div>

                  <template x-if="event.reason">
                    <div class="flex gap-x-0.5">
                      <span>Reason: </span>
                      <div x-text="event.reason"></div>
                    </div>
                  </template>

                  <template x-if="event.image">
                    <div>
                      <img
                        :src="event.image"
                        alt="Event image"
                        class="aspect-video w-72 cursor-pointer rounded-md object-cover hover:opacity-90"
                        @click="selectedImage = event.image"
                      />
                    </div>
                  </template>

                  <div
                    class="rounded-lg bg-gray-100"
                    x-data="{ expanded: false }"
                    x-show="Object.keys(event.fieldsUpdated).length > 0"
                  >
                    <button
                      class="flex w-full items-center justify-between p-4"
                      @click="
                        expanded = !expanded;
                        $nextTick(() => { console.log(event.fieldsUpdated[0]) })
                      "
                      :class="{ 'border-b': expanded }"
                    >
                      <span class="text-sm font-medium text-gray-400">
                        Fields Updated (
                        <span
                          x-text="Object.keys(event.fieldsUpdated).length"
                        ></span>
                        )
                      </span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        :data-expanded="expanded"
                        class="h-4 w-4 transition-transform data-[expanded='true']:rotate-180"
                      >
                        <path d="m6 9 6 6 6-6" />
                      </svg>
                    </button>
                    <div x-show="expanded" x-collapse class="">
                      <table class="w-full">
                        <thead class="border-b text-left">
                          <tr class="">
                            <th class="w-1/5 px-4 py-2">Field</th>
                            <th class="w-2/5 px-4 py-2">From</th>
                            <th class="w-2/5 px-4 py-2">To</th>
                          </tr>
                        </thead>
                        <tbody>
                          <template
                            x-for="[key, value] in Object.entries(event.fieldsUpdated)"
                            :key="key"
                          >
                            <tr class="not-last:border-b">
                              <td class="px-4 py-2" x-text="key"></td>
                              <td class="px-4 py-2"
                                  x-text="value.from === null
                                      ? ''
                                      : (typeof value.from === 'object' ? JSON.stringify(value.from) : value.from)">
                              </td>
                              <td class="px-4 py-2"
                                  x-text="value.to === null
                                      ? ''
                                      : (typeof value.to === 'object' ? JSON.stringify(value.to) : value.to)">
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="rounded-lg" x-data="{ expanded: false }">
                    <button
                      class="flex w-full items-center justify-between p-4"
                      @click="expanded = !expanded"
                    >
                      <span class="text-sm font-medium text-gray-400">
                        Technical Details
                      </span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        :data-expanded="expanded"
                        class="h-4 w-4 transition-transform data-[expanded='true']:rotate-180"
                      >
                        <path d="m6 9 6 6 6-6" />
                      </svg>
                    </button>
                    <div x-show="expanded" x-collapse class="">
                      <div class="rounded-lg bg-gray-200 p-2">
                        <pre><code x-text="event.technicalDetails" class="language-plaintext bg-gray-200!"></code></pre>
                      </div>
                    </div>
                  </div>
                </div>
                <div
                  x-show="event.type === 'status'"
                  class="ml-12 flex flex-col gap-y-2"
                >
                  <div class="flex items-center">
                    <h4 class="text-lg font-medium" x-text="event.action"></h4>
                    <span
                      class="ml-3 text-sm text-gray-400"
                      x-text="formatDate(event.timestamp)"
                    ></span>
                  </div>

                  <div
                    x-show="event.fieldsUpdated && event.fieldsUpdated['status']"
                  >
                    <div class="flex items-center gap-x-3 my-2">
                      <span
                        class="p-3 border rounded-md font-semibold text-sm"
                        :style="'outline: 2px solid ' + (event.fieldsUpdated['status'].from_color || '#ccc')"
                        x-text="event.fieldsUpdated['status'].from?.length ? event.fieldsUpdated['status'].from : '---'"
                      ></span>
                      <svg
                        class="h-5 w-5 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M9 5l7 7-7 7"
                        />
                      </svg>
                      <span
                        class="p-3 border rounded-md font-semibold text-sm"
                        :style="'outline: 2px solid ' + (event.fieldsUpdated['status'].to_color || '#ccc')"
                        x-text="event.fieldsUpdated['status'].to ?? 'None'"
                      ></span>
                    </div>
                  </div>

                  <div class="rounded-lg" x-data="{ expanded: false }">
                    <button
                      class="flex w-full items-center justify-between p-4"
                      @click="expanded = !expanded"
                    >
                      <span class="text-sm font-medium text-gray-400">
                        Technical Details
                      </span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        :data-expanded="expanded"
                        class="h-4 w-4 transition-transform data-[expanded='true']:rotate-180"
                      >
                        <path d="m6 9 6 6 6-6" />
                      </svg>
                    </button>
                    <div x-show="expanded" x-collapse class="">
                      <div class="rounded-lg bg-gray-200 p-2">
                        <pre><code x-text="event.technicalDetails" class="language-plaintext bg-gray-200!"></code></pre>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>

            <template x-if="selectedRecord.events.length === 0">
              <div class="py-8 text-center text-gray-400">
                No traces available for this record.
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
