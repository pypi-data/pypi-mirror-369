#!/bin/bash
set -euo pipefail
source /var/lib/flow/task-runtime.conf
echo "[$(date)] Flow runtime limit reached, initiating graceful shutdown"
docker stop -t 30 main 2>/dev/null || true
sleep 10
INSTANCE_ID=$(curl -s --max-time 5 http://169.254.169.254/latest/meta-data/instance-id || hostname)
TASK_ID=$(curl -s --max-time 10 -H "Authorization: Bearer $MITHRIL_API_KEY" \
    "$MITHRIL_API_URL/v2/spot/bids?project=$MITHRIL_PROJECT" | \
    INSTANCE_ID="$INSTANCE_ID" python3 -c "import sys,json,os;iid=os.environ.get('INSTANCE_ID','');d=json.load(sys.stdin);b=d if isinstance(d,list) else d.get('data',[]);print(next((x.get('fid') for x in b for i in x.get('instances',[]) if i.get('instance_id')==iid), 'unknown'))")
if [ "$TASK_ID" != "unknown" ]; then
  curl -X DELETE -H "Authorization: Bearer $MITHRIL_API_KEY" -H "Content-Type: application/json" "$MITHRIL_API_URL/v2/spot/bids/$TASK_ID" --max-time 30 || true
fi


