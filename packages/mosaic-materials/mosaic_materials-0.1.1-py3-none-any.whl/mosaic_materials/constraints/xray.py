from __future__ import annotations

from typing import TYPE_CHECKING

import numpy as np
import numpy.typing as npt
from ase.data import atomic_numbers

from mosaic_materials.constraints.total_scattering import (
    StructureFactorConstraint,
)
from mosaic_materials.state.composition import Composition

if TYPE_CHECKING:
    from mosaic_materials.engine import MCEngine


class XrayStructureFactorConstraint(StructureFactorConstraint):
    """
    Total X-ray scattering structure factor constraint.

    Uses:
      S_ij(Q) = 4πp Z_i Z_j ∫ [g_ij(r)-1] (r sin(Qr)/Q) dr
    """

    default_minimise_differences: bool = True

    def __init__(
        self,
        name: str,
        q_exp: np.ndarray,
        fq_exp: np.ndarray,
        rdf_constraint_name: str = "c_rdf",
        sigma: np.ndarray | float = 1.0,
        weight: float = 1.0,
        multiply_by_q: bool = False,
        minimise_differences: bool = True,
    ):
        super().__init__(
            name,
            q_exp,
            fq_exp,
            rdf_constraint_name,
            sigma,
            weight,
            multiply_by_q,
            minimise_differences,
        )

    def install(self, engine: MCEngine) -> None:
        """
        Nothing to install in LAMMPS itself. We compute required constants.
        """

        assert engine.system is not None, (
            "System must be set before installing "
            "XRayStructureFactorConstraint."
        )

        super().install(engine)

        self._constants = (
            form_factors(
                engine.system.elements,
                engine.system.element_pairs,
                self.q_exp,
                engine.system.composition,
            )
            * 4 * np.pi
        )

    def _compute_partials(self, gr: np.ndarray) -> np.ndarray:
        """
        Overrides the base so that
           raw = (g(r)-1)·rsum.T   shape (n_pairs, n_Q)
        is multiplied *elementwise* by a same-shape form-factor matrix.
        """

        rho0 = self.engine.system.atomic_number_density

        diffs = gr - 1.0                    # (n_pairs, n_bins)
        raw = diffs.dot(self._rsum)         # (n_pairs, n_Q)            # type: ignore
        return raw * self._constants * rho0 # elementwise → (n_pairs, n_Q)


def form_factors(
    elements: tuple[str, ...],
    atom_pairs: list[tuple[str, str]],
    q_values: np.ndarray,
    composition: Composition,
) -> np.ndarray:
    """
    Vectorized calculation of pairwise partial X‐ray form-factors p_ij(Q).

    f_i(s) = A e^{−a s²} + B e^{−b s²} + C e^{−c s²} + D e^{−d s²} + E
    with s = Q/(4π).

    Then
      p_ij(Q) = α_{ij} c_i c_j f_i(s) f_j(s)
                / [ ∑_k c_k f_k(s) ]²

    Returns
    -------
    ppff : ndarray shape (n_pairs, n_q)
    """

    n_q = q_values.size

    s2 = (q_values / (4 * np.pi)) ** 2
    coeffs = np.array(
        [XRAY_SCATTERING_FACTORS[atomic_numbers[el]] for el in elements],
        dtype=float,
    )

    A, a, B, b, C, c, D, d, E = coeffs.T  # each is shape (n_el,)

    ff = (
        A[:, None] * np.exp(-a[:, None] * s2[None, :])
        + B[:, None] * np.exp(-b[:, None] * s2[None, :])
        + C[:, None] * np.exp(-c[:, None] * s2[None, :])
        + D[:, None] * np.exp(-d[:, None] * s2[None, :])
        + E[:, None]
    )

    conc = np.array([composition.atomic_fraction(el) for el in elements])
    denom = np.sum(conc[:, None] * ff, axis=0) ** 2

    n_pairs = len(atom_pairs)
    ppff = np.empty((n_pairs, n_q), dtype=float)

    for idx, (i_sym, j_sym) in enumerate(atom_pairs):
        i = elements.index(i_sym)
        j = elements.index(j_sym)
        alpha = 2 - int(i == j)
        ppff[idx] = alpha * conc[i] * conc[j] * ff[i] * ff[j]

    ppff /= denom[None, :]

    return ppff


XRAY_SCATTERING_FACTORS: npt.NDArray[np.float64] = np.array(
    [
        [
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
        ],  # NaN.
        [
            0.489918,
            20.659300,
            0.262003,
            7.740390,
            0.196767,
            49.551900,
            0.049879,
            2.201590,
            0.001305,
        ],  # H nu8§z
        [
            0.873400,
            9.103700,
            0.630900,
            3.356800,
            0.311200,
            22.927600,
            0.178000,
            0.982100,
            0.006400,
        ],  # He
        [
            1.128200,
            3.954600,
            0.750800,
            1.052400,
            0.617500,
            85.390500,
            0.465300,
            168.261000,
            0.037700,
        ],  # Li
        [
            1.591900,
            43.642700,
            1.127800,
            1.862300,
            0.539100,
            103.483000,
            0.702900,
            0.542000,
            0.038500,
        ],  # Be
        [
            2.054500,
            23.218500,
            1.332600,
            1.021000,
            1.097900,
            60.349800,
            0.706800,
            0.140300,
            -0.193200,
        ],  # B
        [
            2.310000,
            20.843900,
            1.020000,
            10.207500,
            1.588600,
            0.568700,
            0.865000,
            51.651200,
            0.215600,
        ],  # C
        [
            12.212600,
            0.005700,
            3.132200,
            9.893300,
            2.012500,
            28.997500,
            1.166300,
            0.582600,
            -11.529000,
        ],  # N
        [
            3.048500,
            13.277100,
            2.286800,
            5.701100,
            1.546300,
            0.323900,
            0.867000,
            32.908900,
            0.250800,
        ],  # O
        [
            3.539200,
            10.282500,
            2.641200,
            4.294400,
            1.517000,
            0.261500,
            1.024300,
            26.147600,
            0.277600,
        ],  # F
        [
            3.955300,
            8.404200,
            3.112500,
            3.426200,
            1.454600,
            0.230600,
            1.125100,
            21.718400,
            0.351500,
        ],  # Ne
        [
            4.762600,
            3.285000,
            3.173600,
            8.842200,
            1.267400,
            0.313600,
            1.112800,
            129.424000,
            0.676000,
        ],  # Na
        [
            5.420400,
            2.827500,
            2.173500,
            79.261100,
            1.226900,
            0.380800,
            2.307300,
            7.193700,
            0.858400,
        ],  # Mg
        [
            6.420200,
            3.038700,
            1.900200,
            0.742600,
            1.593600,
            31.547200,
            1.964600,
            85.088600,
            1.115100,
        ],  # Al
        [
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
        ],  # Si
        [
            6.434500,
            1.906700,
            4.179100,
            27.157000,
            1.780000,
            0.526000,
            1.490800,
            68.164500,
            1.114900,
        ],  # P
        [
            6.905300,
            1.467900,
            5.203400,
            22.215100,
            1.437900,
            0.253600,
            1.586300,
            56.172000,
            0.866900,
        ],  # S
        [
            11.460400,
            0.010400,
            7.196400,
            1.166200,
            6.255600,
            18.519400,
            1.645500,
            47.778400,
            -9.557400,
        ],  # Cl
        [
            7.484500,
            0.907200,
            6.772300,
            14.840700,
            0.653900,
            43.898300,
            1.644200,
            33.392900,
            1.444500,
        ],  # Ar
        [
            8.218600,
            12.794900,
            7.439800,
            0.774800,
            1.051900,
            213.187000,
            0.865900,
            41.684100,
            1.422800,
        ],  # K
        [
            8.626600,
            10.442100,
            7.387300,
            0.659900,
            1.589900,
            85.748400,
            1.021100,
            178.437000,
            1.375100,
        ],  # Ca
        [
            9.189000,
            9.021300,
            7.367900,
            0.572900,
            1.640900,
            136.108000,
            1.468000,
            51.353100,
            1.332900,
        ],  # Sc
        [
            9.759500,
            7.850800,
            7.355800,
            0.500000,
            1.699100,
            35.633800,
            1.902100,
            116.105000,
            1.280700,
        ],  # Ti
        [
            10.297100,
            6.865700,
            7.351100,
            0.438500,
            2.070300,
            26.893800,
            2.057100,
            102.478000,
            1.219900,
        ],  # V
        [
            10.640600,
            6.103800,
            7.353700,
            0.392000,
            3.324000,
            20.262600,
            1.492200,
            98.739900,
            1.183200,
        ],  # Cr
        [
            11.281900,
            5.340900,
            7.357300,
            0.343200,
            3.019300,
            17.867400,
            2.244100,
            83.754300,
            1.089600,
        ],  # Mn
        [
            11.769500,
            4.761100,
            7.357300,
            0.307200,
            3.522200,
            15.353500,
            2.304500,
            76.880500,
            1.036900,
        ],  # Fe
        [
            12.284100,
            4.279100,
            7.340900,
            0.278400,
            4.003400,
            13.535900,
            2.348800,
            71.169200,
            1.011800,
        ],  # Co
        [
            12.837600,
            3.878500,
            7.292000,
            0.256500,
            4.443800,
            12.176300,
            2.380000,
            66.342100,
            1.034100,
        ],  # Ni
        [
            13.338000,
            3.582800,
            7.167600,
            0.247000,
            5.615800,
            11.396600,
            1.673500,
            64.812600,
            1.191000,
        ],  # Cu
        [
            14.074300,
            3.265500,
            7.031800,
            0.233300,
            5.165200,
            10.316300,
            2.410000,
            58.709700,
            1.304100,
        ],  # Zn
        [
            15.235400,
            3.066900,
            6.700600,
            0.241200,
            4.359100,
            10.780500,
            2.962300,
            61.413500,
            1.718900,
        ],  # Ga
        [
            16.081600,
            2.850900,
            6.374700,
            0.251600,
            3.706800,
            11.446800,
            3.683000,
            54.762500,
            2.131300,
        ],  # Ge
        [
            16.672300,
            2.634500,
            6.070100,
            0.264700,
            3.431300,
            12.947900,
            4.277900,
            47.797200,
            2.531000,
        ],  # As
        [
            17.000600,
            2.409800,
            5.819600,
            0.272600,
            3.973100,
            15.237200,
            4.354300,
            43.816300,
            2.840900,
        ],  # Se
        [
            17.178900,
            2.172300,
            5.235800,
            16.579600,
            5.637700,
            0.260900,
            3.985100,
            41.432800,
            2.955700,
        ],  # Br
        [
            17.355500,
            1.938400,
            6.728600,
            16.562300,
            5.549300,
            0.226100,
            3.537500,
            39.397200,
            2.825000,
        ],  # Kr
        [
            17.178400,
            1.788800,
            9.643500,
            17.315100,
            5.139900,
            0.274800,
            1.529200,
            164.934000,
            3.487300,
        ],  # Rb
        [
            17.566300,
            1.556400,
            9.818400,
            14.098800,
            5.422000,
            0.166400,
            2.669400,
            132.376000,
            2.506400,
        ],  # Sr
        [
            17.776000,
            1.402900,
            10.294600,
            12.800600,
            5.726290,
            0.125599,
            3.265880,
            104.354000,
            1.912130,
        ],  # Y
        [
            17.876500,
            1.276180,
            10.948000,
            11.916000,
            5.417320,
            0.117622,
            3.657210,
            87.662700,
            2.069290,
        ],  # Zr
        [
            17.614200,
            1.188650,
            12.014400,
            11.766000,
            4.041830,
            0.204785,
            3.533460,
            69.795700,
            3.755910,
        ],  # Nb
        [
            3.702500,
            0.277200,
            17.235600,
            1.095800,
            12.887600,
            11.004000,
            3.742900,
            61.658400,
            4.387500,
        ],  # Mo
        [
            19.130100,
            0.864132,
            11.094800,
            8.144870,
            4.649010,
            21.570700,
            2.712630,
            86.847200,
            5.404280,
        ],  # Tc
        [
            19.267400,
            0.808520,
            12.918200,
            8.434670,
            4.863370,
            24.799700,
            1.567560,
            94.292800,
            5.378740,
        ],  # Ru
        [
            19.295700,
            0.751536,
            14.350100,
            8.217580,
            4.734250,
            25.874900,
            1.289180,
            98.606200,
            5.328000,
        ],  # Rh
        [
            19.331900,
            0.698655,
            15.501700,
            7.989290,
            5.295370,
            25.205200,
            0.605844,
            76.898600,
            5.265930,
        ],  # Pd
        [
            19.280800,
            0.644600,
            16.688500,
            7.472600,
            4.804500,
            24.660500,
            1.046300,
            99.815600,
            5.179000,
        ],  # Ag
        [
            19.221400,
            0.594600,
            17.644400,
            6.908900,
            4.461000,
            24.700800,
            1.602900,
            87.482500,
            5.069400,
        ],  # Cd
        [
            19.162400,
            0.547600,
            18.559600,
            6.377600,
            4.294800,
            25.849900,
            2.039600,
            92.802900,
            4.939100,
        ],  # In
        [
            19.188900,
            5.830300,
            19.100500,
            0.503100,
            4.458500,
            26.890900,
            2.466300,
            83.957100,
            4.782100,
        ],  # Sn
        [
            19.641800,
            5.303400,
            19.045500,
            0.460700,
            5.037100,
            27.907400,
            2.682700,
            75.282500,
            4.590900,
        ],  # Sb
        [
            19.964400,
            4.817420,
            19.013800,
            0.420885,
            6.144870,
            28.528400,
            2.523900,
            70.840300,
            4.352000,
        ],  # Te
        [
            20.147200,
            4.347000,
            18.994900,
            0.381400,
            7.513800,
            27.766000,
            2.273500,
            66.877600,
            4.071200,
        ],  # I
        [
            20.293300,
            3.928200,
            19.029800,
            0.344000,
            8.976700,
            26.465900,
            1.990000,
            64.265800,
            3.711800,
        ],  # Xe
        [
            20.389200,
            3.569000,
            19.106200,
            0.310700,
            10.662000,
            24.387900,
            1.495300,
            213.904000,
            3.335200,
        ],  # Cs
        [
            20.336100,
            3.216000,
            19.297000,
            0.275600,
            10.888000,
            20.207300,
            2.695900,
            167.202000,
            2.773100,
        ],  # Ba
        [
            20.578000,
            2.948170,
            19.599000,
            0.244475,
            11.372700,
            18.772600,
            3.287190,
            133.124000,
            2.146780,
        ],  # La
        [
            21.167100,
            2.812190,
            19.769500,
            0.226836,
            11.851300,
            17.608300,
            3.330490,
            127.113000,
            1.862640,
        ],  # Ce
        [
            22.044000,
            2.773930,
            19.669700,
            0.222087,
            12.385600,
            16.766900,
            2.824280,
            143.644000,
            2.058300,
        ],  # Pr
        [
            22.684500,
            2.662480,
            19.684700,
            0.210628,
            12.774000,
            15.885000,
            2.851370,
            137.903000,
            1.984860,
        ],  # Nd
        [
            23.340500,
            2.562700,
            19.609500,
            0.202088,
            13.123500,
            15.100900,
            2.875160,
            132.721000,
            2.028760,
        ],  # Pm
        [
            24.004200,
            2.472740,
            19.425800,
            0.196451,
            13.439600,
            14.399600,
            2.896040,
            128.007000,
            2.209630,
        ],  # Sm
        [
            24.627400,
            2.387900,
            19.088600,
            0.194200,
            13.760300,
            13.754600,
            2.922700,
            123.174000,
            2.574500,
        ],  # Eu
        [
            25.070900,
            2.253410,
            19.079800,
            0.181951,
            13.851800,
            12.933100,
            3.545450,
            101.398000,
            2.419600,
        ],  # Gd
        [
            25.897600,
            2.242560,
            18.218500,
            0.196143,
            14.316700,
            12.664800,
            2.953540,
            115.362000,
            3.583240,
        ],  # Tb
        [
            26.507000,
            2.180200,
            17.638300,
            0.202172,
            14.559600,
            12.189900,
            2.965770,
            111.874000,
            4.297280,
        ],  # Dy
        [
            26.904900,
            2.070510,
            17.294000,
            0.197940,
            14.558300,
            11.440700,
            3.638370,
            92.656600,
            4.567960,
        ],  # Ho
        [
            27.656300,
            2.073560,
            16.428500,
            0.223545,
            14.977900,
            11.360400,
            2.982330,
            105.703000,
            5.920460,
        ],  # Er
        [
            28.181900,
            2.028590,
            15.885100,
            0.238849,
            15.154200,
            10.997500,
            2.987060,
            102.961000,
            6.756210,
        ],  # Tm
        [
            28.664100,
            1.988900,
            15.434500,
            0.257119,
            15.308700,
            10.664700,
            2.989630,
            100.417000,
            7.566720,
        ],  # Yb
        [
            28.947600,
            1.901820,
            15.220800,
            9.985190,
            15.100000,
            0.261033,
            3.716010,
            84.329800,
            7.976280,
        ],  # Lu
        [
            29.144000,
            1.832620,
            15.172600,
            9.599900,
            14.758600,
            0.275116,
            4.300130,
            72.029000,
            8.581540,
        ],  # Hf
        [
            29.202400,
            1.773330,
            15.229300,
            9.370460,
            14.513500,
            0.295977,
            4.764920,
            63.364400,
            9.243540,
        ],  # Ta
        [
            29.081800,
            1.720290,
            15.430000,
            9.225900,
            14.432700,
            0.321703,
            5.119820,
            57.056000,
            9.887500,
        ],  # W
        [
            28.762100,
            1.671910,
            15.718900,
            9.092270,
            14.556400,
            0.350500,
            5.441740,
            52.086100,
            10.472000,
        ],  # Re
        [
            28.189400,
            1.629030,
            16.155000,
            8.979480,
            14.930500,
            0.382661,
            5.675890,
            48.164700,
            11.000500,
        ],  # Os
        [
            27.304900,
            1.592790,
            16.729600,
            8.865530,
            15.611500,
            0.417916,
            5.833770,
            45.001100,
            11.472200,
        ],  # Ir
        [
            27.005900,
            1.512930,
            17.763900,
            8.811740,
            15.713100,
            0.424593,
            5.783700,
            38.610300,
            11.688300,
        ],  # Pt
        [
            16.881900,
            0.461100,
            18.591300,
            8.621600,
            25.558200,
            1.482600,
            5.860000,
            36.395600,
            12.065800,
        ],  # Au
        [
            20.680900,
            0.545000,
            19.041700,
            8.448400,
            21.657500,
            1.572900,
            5.967600,
            38.324600,
            12.608900,
        ],  # Hg
        [
            27.544600,
            0.655150,
            19.158400,
            8.707510,
            15.538000,
            1.963470,
            5.525930,
            45.814900,
            13.174600,
        ],  # Tl
        [
            31.061700,
            0.690200,
            13.063700,
            2.357600,
            18.442000,
            8.618000,
            5.969600,
            47.257900,
            13.411800,
        ],  # Pb
        [
            33.368900,
            0.704000,
            12.951000,
            2.923800,
            16.587700,
            8.793700,
            6.469200,
            48.009300,
            13.578200,
        ],  # Bi
        [
            34.672600,
            0.700999,
            15.473300,
            3.550780,
            13.113800,
            9.556420,
            7.025880,
            47.004500,
            13.677000,
        ],  # Po
        [
            35.316300,
            0.685870,
            19.021100,
            3.974580,
            9.498870,
            11.382400,
            7.425180,
            45.471500,
            13.710800,
        ],  # At
        [
            35.563100,
            0.663100,
            21.281600,
            4.069100,
            8.003700,
            14.042200,
            7.443300,
            44.247300,
            13.690500,
        ],  # Rn
        [
            35.929900,
            0.646453,
            23.054700,
            4.176190,
            12.143900,
            23.105200,
            2.112530,
            150.645000,
            13.724700,
        ],  # Fr
        [
            35.763000,
            0.616341,
            22.906400,
            3.871350,
            12.473900,
            19.988700,
            3.210970,
            142.325000,
            13.621100,
        ],  # Ra
        [
            35.659700,
            0.589092,
            23.103200,
            3.651550,
            12.597700,
            18.599000,
            4.086550,
            117.020000,
            13.526600,
        ],  # Ac
        [
            35.564500,
            0.563359,
            23.421900,
            3.462040,
            12.747300,
            17.830900,
            4.807030,
            99.172200,
            13.431400,
        ],  # Th
        [
            35.884700,
            0.547751,
            23.294800,
            3.415190,
            14.189100,
            16.923500,
            4.172870,
            105.251000,
            13.428700,
        ],  # Pa
        [
            36.022800,
            0.529300,
            23.412800,
            3.325300,
            14.949100,
            16.092700,
            4.188000,
            100.613000,
            13.396600,
        ],  # U
        [
            36.187400,
            0.511929,
            23.596400,
            3.253960,
            15.640200,
            15.362200,
            4.185500,
            97.490800,
            13.357300,
        ],  # Np
        [
            36.525400,
            0.499384,
            23.808300,
            3.263710,
            16.770700,
            14.945500,
            3.479470,
            105.980000,
            13.381200,
        ],  # Pu
        [
            36.670600,
            0.483629,
            24.099200,
            3.206470,
            17.341500,
            14.313600,
            3.493310,
            102.273000,
            13.359200,
        ],  # Am
        [
            36.648800,
            0.465154,
            24.409600,
            3.089970,
            17.399000,
            13.434600,
            4.216650,
            88.483400,
            13.288700,
        ],  # Cm
        [
            36.788100,
            0.451018,
            24.773600,
            3.046190,
            17.891900,
            12.894600,
            4.232840,
            86.003000,
            13.275400,
        ],  # Bk
        [
            36.918500,
            0.437533,
            25.199500,
            3.007750,
            18.331700,
            12.404400,
            4.243910,
            83.788100,
            13.267400,
        ],  # Cf
        [
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
            np.nan,
        ],  # Es
    ]
)
