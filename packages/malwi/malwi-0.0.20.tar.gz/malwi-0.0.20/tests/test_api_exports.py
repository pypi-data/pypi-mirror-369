"""Test the public API exports."""


def test_api_imports():
    """Test that all API components can be imported."""
    from malwi import __version__, MalwiReport, MalwiObject

    # Check version
    assert isinstance(__version__, str)
    assert len(__version__) > 0  # Just check it's not empty

    # Check functions/classes exist
    assert isinstance(MalwiReport, type)
    assert isinstance(MalwiObject, type)
    assert callable(MalwiReport.create)


def test_malwi_report_create_api(tmp_path):
    """Test the MalwiReport.create method works through the API."""
    from malwi import MalwiReport, __version__

    # Create a simple Python file
    test_file = tmp_path / "test.py"
    test_file.write_text("print('hello world')")

    # Test the API
    result = MalwiReport.create(
        input_path=test_file,
        accepted_extensions=["py"],
        predict=False,  # Disable ML to avoid model dependencies
        silent=True,
    )

    # Check result type
    assert isinstance(result, MalwiReport)
    assert len(result.all_objects) > 0
    # Version should contain the base version string
    assert __version__ in result.version
    assert isinstance(result.version, str)
    assert len(result.version) > 0


def test_malwi_report_exports():
    """Test MalwiReport export methods work through the API."""
    from malwi import MalwiReport, __version__

    # Create a minimal report
    report = MalwiReport(
        all_objects=[],
        malicious_objects=[],
        threshold=0.7,
        all_files=[],
        skipped_files=[],
        processed_files=0,
        malicious=False,
        confidence=1.0,
        activities=[],
        input="/test/path",
        start="2024-01-01T12:00:00",
        duration=1.5,
    )

    # Test export methods - version should contain base version
    json_output = report.to_report_json()
    yaml_output = report.to_report_yaml()
    markdown_output = report.to_report_markdown()

    assert '"version":' in json_output
    assert __version__ in json_output
    assert '"input": "/test/path"' in json_output
    assert "version:" in yaml_output
    assert __version__ in yaml_output
    assert "input: /test/path" in yaml_output
    assert "Generated by malwi" in markdown_output
    assert __version__ in markdown_output
    assert "Target:** `/test/path`" in markdown_output
    assert "ðŸŸ¢ good" in report.to_demo_text()
    assert "- target: /test/path" in report.to_demo_text()
