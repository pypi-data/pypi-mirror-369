image: python:3.11

stages:
- build
- test
- deploy
- publish


before_script:
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - source $HOME/.local/bin/env
  - uv venv
  - source .venv/bin/activate

variables:
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.uv-cache"
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_TLS_CERTDIR: ""

build_test_wheel:
  stage: build
  script:
    - apt update && apt install -y gfortran
    - ./scripts/generate_meson.sh
    - curl -sSL https://get.docker.com/ | sh
    - uv pip install cibuildwheel
    - cibuildwheel --only cp311-manylinux_x86_64 --output-dir dist .
    - python -m build --sdist
    - ls -l dist
  artifacts:
    expire_in: 2 hours
    paths:
      - dist

tests:
  stage: test
  script:
    - uv pip install dist/*.whl pytest
    - pytest --slow

profile:
  stage: deploy
  script:
    - apt update && apt install -y gfortran libopenmpi-dev
    - uv pip install mpi4py line_profiler==4.2.0 dist/*.whl
    # Serial profiling.
    - OMP_NUM_THREADS=1 LINE_PROFILE=1 turbigen examples/axial_turbine.yaml -I
    - cat profile_output.txt
    # Now parallel benchmarking
    - ./scripts/benchmark.sh

doc:
  stage: deploy
  artifacts:
    paths:
      - doc/_build
  script:
    - apt update && apt install -y pdf2svg fonts-freefont-ttf
    - uv pip install dist/*.whl sphinx sphinx-autobuild sphinx-argparse sphinxcontrib-programoutput sphinxcontrib-bibtex snowballstemmer==2.2.0 autodocsumm
    - python doc/generate_examples.py
    - python doc/generate_meanline.py
    - python doc/generate_data_structures.py
    - sphinx-build -W doc doc/_build

build_all_wheels:
  stage: deploy
  script:
    - apt update && apt install -y gfortran
    - ./scripts/generate_meson.sh
    - curl -sSL https://get.docker.com/ | sh
    - uv pip install cibuildwheel
    - cibuildwheel --platform linux --output-dir dist .
    - python -m build --sdist
    - ls -l dist
  artifacts:
    expire_in: 1 day
    paths:
      - dist

pypi:
  stage: publish
  script:
    - uv pip install twine
    - ls -l dist
    - twine upload dist/*
  only:
    - master


pages:
  stage: publish
  script:
    - mv doc/_build public
  artifacts:
    paths:
      - public
  only:
  - master
