<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tutorial &#8212; turbigen 1.10.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=a66d8bb5" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <script src="_static/documentation_options.js?v=b95c35c0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>window.MathJax = {"tex": {"macros": {"Ma": "{M\\kern-.1ema}", "Rey": "{R\\kern-.1eme}", "htr": "{\\mathit{HTR}}", "inn": "{\\mathrm{in}}", "out": "{\\mathrm{out}}", "rel": "{\\mathrm{rel}}", "Chi": "{\\hat{\\chi}}", "TE": "{\\mathrm{TE}}", "LE": "{\\mathrm{LE}}", "dee": "\\mathrm{d}", "RR": "{\\mathit{RR}}", "VmR": "{\\mathit{VR}}"}}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Configuration file format" href="config.html" />
    <link rel="prev" title="Command-line options" href="usage.html" />

  <link rel="stylesheet" href="_static/custom.css" type="text/css" />





  </head><body>
  <div class="document">

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">turbigen</a></h1>



<p class="blurb">Version 1.10.1</p>






<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="nomenclature.html">Nomenclature</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Command-line options</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#problem-statement">Problem statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mean-line-design-equations">Mean-line design equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-skeleton-files">Setting up skeleton files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-the-algorithm">Implementing the algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inverse-function">Inverse function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-cfd">Running CFD</a></li>
<li class="toctree-l2"><a class="reference internal" href="#iterating-the-design">Iterating the design</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extensions">Extensions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="fluid.html">Fluids</a></li>
<li class="toctree-l1"><a class="reference internal" href="meanline.html">Mean-line</a></li>
<li class="toctree-l1"><a class="reference internal" href="mesh.html">Meshing</a></li>
<li class="toctree-l1"><a class="reference internal" href="solver.html">Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="post.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="usage.html" title="previous chapter">Command-line options</a></li>
      <li>Next: <a href="config.html" title="next chapter">Configuration file format</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">


          <div class="body" role="main">

  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Link to this heading">¶</a></h1>
<p>This tutorial will walk through the process of writing a new user-defined
mean-line solver and using it to run CFD on the Cambridge Wilkes3 cluster.
We first need to download the <strong class="program">turbigen</strong> code:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://gitlab.developers.cam.ac.uk/jb753/turbigen.git
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>turbigen
<span class="gp">$ </span><span class="nb">source</span><span class="w"> </span>setup.sh
</pre></div>
</div>
<section id="problem-statement">
<h2>Problem statement<a class="headerlink" href="#problem-statement" title="Link to this heading">¶</a></h2>
<p>Suppose we wish to design a rotor-only axial fan. We shall assume
a constant axial velocity. The inlet state is specified
as fixed values of <span class="math notranslate nohighlight">\(T_{01}\)</span> and <span class="math notranslate nohighlight">\(p_{01}\)</span> with no inlet swirl,
<span class="math notranslate nohighlight">\(\alpha_1=0\)</span>. We can then parametrise the aerodynamics of the stage using the
following design variables:</p>
<ul class="simple">
<li><p>Total pressure rise, <span class="math notranslate nohighlight">\(\Delta p_0\)</span></p></li>
<li><p>Mass flow rate, <span class="math notranslate nohighlight">\(\dot{m}\)</span></p></li>
<li><p>Flow coefficient, <span class="math notranslate nohighlight">\(\phi=V_x/U\)</span></p></li>
<li><p>Loading coefficient, <span class="math notranslate nohighlight">\(\psi= \Delta h_0/U^2\)</span></p></li>
<li><p>Hub-to-tip ratio, <span class="math notranslate nohighlight">\(\mathit{HTR}=r_\mathrm{hub}/r_\mathrm{cas}\)</span></p></li>
<li><p>Total-to-total isentropic efficiency guess, <span class="math notranslate nohighlight">\(\eta_\mathrm{tt}\)</span></p></li>
</ul>
<p>To proceed with the annulus and blade shape design, <strong class="program">turbigen</strong> requires the following quantities to be calculated from the above information. At the inlet and exit of the blade row:</p>
<ul class="simple">
<li><p>Mean radii, <span class="math notranslate nohighlight">\(r_\mathrm{rms}\)</span></p></li>
<li><p>Annulus areas, <span class="math notranslate nohighlight">\(A\)</span></p></li>
<li><p>Absolute frame velocity vectors, <span class="math notranslate nohighlight">\((V_x, V_r, V_\theta)\)</span></p></li>
<li><p>Static thermodynamic states, <span class="math notranslate nohighlight">\((P, T)\)</span> for example</p></li>
<li><p>Rotor shaft speed, <span class="math notranslate nohighlight">\(\Omega\)</span></p></li>
</ul>
<p><span class="math notranslate nohighlight">\(r_\mathrm{rms}\)</span>, <span class="math notranslate nohighlight">\(A\)</span>, <span class="math notranslate nohighlight">\(\Omega\)</span> and the thermodynamic states
should all be arrays of length 2. The velocity vectors should be of shape (3,2).</p>
</section>
<section id="mean-line-design-equations">
<span id="tut-ml-algo"></span><h2>Mean-line design equations<a class="headerlink" href="#mean-line-design-equations" title="Link to this heading">¶</a></h2>
<p>We need to combine conservation of mass, momentum, and energy with
definitions of our design variables to solve for the flow in the turbomachine.
This will yield a set of equations that we will later implement numerically in
the <cite>forward</cite> function.</p>
<p>The specified total pressure rise and guess of total-to-total efficiency allow calculation of the compressor work <span class="math notranslate nohighlight">\(\Delta h_0 = h_{02}-h_{01}\)</span></p>
<div class="math notranslate nohighlight" id="equation-eqn-eta">
<span class="eqno">(1)<a class="headerlink" href="#equation-eqn-eta" title="Link to this equation">¶</a></span>\[\eta_\mathrm{tt} = \frac{h_{02s}-h_{01}}{h_{02}-h_{01}} \quad\Rightarrow\quad \Delta h_0 = \frac{1}{\eta_\mathrm{tt}}\left[h(p_{01}+\Delta p_0, s_1) - h_{01}\right]\]</div>
<p>where <span class="math notranslate nohighlight">\(h_{02s}=h(p_{01}+\Delta p_0, s_1)\)</span> is the ideal exit stagnation enthalpy for isentropic compression, i.e. enthalpy evaluated at the real exit stagnation pressure and inlet entropy.</p>
<p>The blade speed <span class="math notranslate nohighlight">\(U\)</span> is then given from the definition of loading coefficient</p>
<div class="math notranslate nohighlight" id="equation-eqn-psi">
<span class="eqno">(2)<a class="headerlink" href="#equation-eqn-psi" title="Link to this equation">¶</a></span>\[\psi = \frac{\Delta h_0}{U^2} \quad\Rightarrow\quad U = \sqrt{\frac{\Delta h_0}{\psi}}\]</div>
<p>The definition of flow coefficient yields the axial velocity <span class="math notranslate nohighlight">\(V_x\)</span></p>
<div class="math notranslate nohighlight" id="equation-eqn-phi">
<span class="eqno">(3)<a class="headerlink" href="#equation-eqn-phi" title="Link to this equation">¶</a></span>\[\phi = \frac{V_x}{U} \quad\Rightarrow\quad V_x = \phi U\]</div>
<p>Assuming no inlet swirl, <span class="math notranslate nohighlight">\(V_{\theta 1}=0\)</span> and the Euler work equation yields the rotor exit circumferential velocity</p>
<div class="math notranslate nohighlight" id="equation-eqn-vt">
<span class="eqno">(4)<a class="headerlink" href="#equation-eqn-vt" title="Link to this equation">¶</a></span>\[\Delta h_0 = U\left(V_{\theta 2}-V_{\theta 1}\right)\quad\Rightarrow\quad V_{\theta 2}=\frac{\Delta h_0}{U}\]</div>
<p>We now have stagnation thermodynamic states and velocity vectors at inlet and
exit of the rotor. If we knew the equation of state of the working fluid, we
could evaluate static thermodynamic states and quantities such as density.</p>
<p>Conservation of mass gives the annulus area</p>
<div class="math notranslate nohighlight" id="equation-eqn-a">
<span class="eqno">(5)<a class="headerlink" href="#equation-eqn-a" title="Link to this equation">¶</a></span>\[\dot{m} = \rho A V_x \quad\Rightarrow\quad A = \frac{\dot{m}}{\rho V_x}\]</div>
<p>and further specifying a hub-to-tip ratio fixes the mean radius</p>
<div class="math notranslate nohighlight">
\[A = \pi\left(r_\mathrm{cas}^2 - r_\mathrm{hub}^2\right)\,,\
r_\mathrm{rms} = \sqrt{\frac{1}{2}\left(r_\mathrm{cas}^2 + r_\mathrm{hub}^2\right)}
\,,\ \mathit{HTR}=\frac{r_\mathrm{hub}}{r_\mathrm{cas}}\]</div>
<div class="math notranslate nohighlight" id="equation-eqn-rrms">
<span class="eqno">(6)<a class="headerlink" href="#equation-eqn-rrms" title="Link to this equation">¶</a></span>\[\Rightarrow r_\mathrm{rms} = \sqrt{\frac{A}{2\pi}\frac{1+\mathit{HTR}^2}{1-\mathit{HTR}^2}}\]</div>
<p>Finally, the shaft angular velocity is simply</p>
<div class="math notranslate nohighlight" id="equation-eqn-omega">
<span class="eqno">(7)<a class="headerlink" href="#equation-eqn-omega" title="Link to this equation">¶</a></span>\[\Omega = U/r_\mathrm{rms}\]</div>
</section>
<section id="setting-up-skeleton-files">
<h2>Setting up skeleton files<a class="headerlink" href="#setting-up-skeleton-files" title="Link to this heading">¶</a></h2>
<p>To integrate our new mean-line design into <strong class="program">turbigen</strong>, we have two
functions to write: a <cite>forward</cite> function which takes our design variables as
inputs and returns a <a class="reference internal" href="meanline.html#turbigen.meanline.MeanLine" title="turbigen.meanline.MeanLine"><code class="xref py py-class docutils literal notranslate"><span class="pre">turbigen.meanline.MeanLine</span></code></a> object; and an
<cite>inverse</cite> function that recalculates the design variables from an input
<a class="reference internal" href="meanline.html#turbigen.meanline.MeanLine" title="turbigen.meanline.MeanLine"><code class="xref py py-class docutils literal notranslate"><span class="pre">turbigen.meanline.MeanLine</span></code></a> object. Now that we know what input and
output data are required, and have the equations for our algorithm, we can start writing the functions. In a new file
called <cite>fan.py</cite>, copy and paste these definitions:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">turbigen.flowfield</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">So1</span><span class="p">,</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">mdot</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">htr</span><span class="p">,</span> <span class="n">etatt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Caluclate mean-line from inlet and design variables.&quot;&quot;&quot;</span>

    <span class="c1"># Insert code to calculate rrms, A, Omega, Vxrt, states</span>
    <span class="c1"># ...</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Return assembled mean-line object</span>
    <span class="k">return</span> <span class="n">turbigen</span><span class="o">.</span><span class="n">flowfield</span><span class="o">.</span><span class="n">make_mean_line</span><span class="p">(</span>
        <span class="n">rrms</span><span class="p">,</span>  <span class="c1"># Mean radii</span>
        <span class="n">A</span><span class="p">,</span>  <span class="c1"># Annulus areas</span>
        <span class="n">Omega</span><span class="p">,</span>  <span class="c1"># Shaft angular velocity</span>
        <span class="n">Vxrt</span><span class="p">,</span> <span class="c1"># Velocity vectors</span>
        <span class="n">S</span>  <span class="c1"># Thermodynamic states</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="n">ml</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate design variables from a mean-line object.&quot;&quot;&quot;</span>

    <span class="c1"># The output should be a dictionary keyed by the args to forward</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;So1&#39;</span><span class="p">:</span> <span class="n">ml</span><span class="o">.</span><span class="n">stagnation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="c1"># &#39;DPo&#39;: ...,</span>
        <span class="c1"># &#39;mdot&#39;: ...,</span>
        <span class="c1"># &#39;phi&#39;: ...,</span>
        <span class="c1"># &#39;psi&#39;: ...,</span>
        <span class="c1"># &#39;htr&#39;: ...,</span>
        <span class="c1"># &#39;etatt&#39;: ...,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<p><cite>So1</cite> is a fluid object that encapsualtes the inlet stagnation thermodynamic state. All
thermodynamic properties can be accessed as attributes, and there are functions
to manipulate the state to new values, described fully in <a class="reference internal" href="fluid.html#module-turbigen.fluid" title="turbigen.fluid"><code class="xref py py-mod docutils literal notranslate"><span class="pre">turbigen.fluid</span></code></a> .</p>
<p>We also need a minimal configuration file to test our mean-line functions.
Create a new <cite>config.yaml</cite> with the following content:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">config.yaml</span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># All files relating to the case are held in a working directory</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runs/fan</span>

<span class="c1"># Perfect gas inlet state</span>
<span class="nt">inlet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Po</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1e5</span>
<span class="w">    </span><span class="nt">To</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.</span>
<span class="w">    </span><span class="nt">cp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1005.</span>
<span class="w">    </span><span class="nt">mu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.8e-5</span>
<span class="w">    </span><span class="nt">gamma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.4</span>

<span class="c1"># Mean-line design</span>
<span class="nt">mean_line</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fan.py</span><span class="w">  </span><span class="c1"># Path to the mean-line module we are writing</span>
<span class="w">    </span><span class="c1"># Our chosen design variables (args to forward)</span>
<span class="w">    </span><span class="nt">DPo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000.</span>
<span class="w">    </span><span class="nt">mdot</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.</span>
<span class="w">    </span><span class="nt">phi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">    </span><span class="nt">psi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span>
<span class="w">    </span><span class="nt">htr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.8</span>
<span class="w">    </span><span class="nt">etatt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9</span>
</pre></div>
</div>
</div>
<p>At this point, running the config.yaml file through <strong class="program">turbigen</strong>
generates a <cite>NotImplementedError</cite> because the body of the <cite>forward</cite> function is
missing.</p>
</section>
<section id="implementing-the-algorithm">
<h2>Implementing the algorithm<a class="headerlink" href="#implementing-the-algorithm" title="Link to this heading">¶</a></h2>
<p>We can now start to add the <a class="reference internal" href="#tut-ml-algo"><span class="std std-ref">Mean-line design equations</span></a> to the <cite>forward</cite> function inside
<cite>fan.py</cite>.</p>
<p>The first task is to calculate the ideal exit enthalpy <span class="math notranslate nohighlight">\(h_{02s}=h(p_{01}+\Delta p_0, s_1)\)</span>
in Eqn. <a class="reference internal" href="#equation-eqn-eta">(1)</a>. Mean-line design functions should be written to make
no assumptions about the working fluid equation of state — this is accomplished
using the fluid modelling abstractions in <a class="reference internal" href="fluid.html#module-turbigen.fluid" title="turbigen.fluid"><code class="xref py py-mod docutils literal notranslate"><span class="pre">turbigen.fluid</span></code></a>. We take a
copy of the inlet state, and set its pressure and entropy to the required
values.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id3" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">So1</span><span class="p">,</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">mdot</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">htr</span><span class="p">,</span> <span class="n">etatt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Caluclate mean-line from inlet and design variables.&quot;&quot;&quot;</span>

    <span class="c1"># Get the ideal exit state</span>
    <span class="n">So2s</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Duplicate the inlet state</span>
    <span class="n">So2s</span><span class="o">.</span><span class="n">set_P_s</span><span class="p">(</span><span class="n">So1</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">So1</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># Set pressure and entropy</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<p>We can now calculate the compressor work by reading off
enthalpy values from our two state objects <cite>So1</cite> and <cite>So2s</cite>.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id4" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># ...</span>

    <span class="c1"># Work from defn efficiency Eqn. (1)</span>
    <span class="n">Dho</span> <span class="o">=</span> <span class="p">(</span><span class="n">So2s</span><span class="o">.</span><span class="n">h</span><span class="o">-</span><span class="n">So1</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="n">etatt</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<p>Proceeding straightforwardly to calculate blade speed and velocity vectors</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id5" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># ...</span>

    <span class="c1"># Blade speed from defn psi Eqn. (2)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Dho</span><span class="o">/</span><span class="n">psi</span><span class="p">)</span>

    <span class="c1"># Axial velocity from defn phi Eqn. (3)</span>
    <span class="n">Vx</span> <span class="o">=</span> <span class="n">phi</span><span class="o">*</span><span class="n">U</span>

    <span class="c1"># Circumferential velocity from Euler Eqn. (4)</span>
    <span class="n">Vt2</span> <span class="o">=</span> <span class="n">Dho</span><span class="o">/</span><span class="n">U</span>

    <span class="c1"># Assemble velocity vectors</span>
    <span class="c1"># shape (3 directions, 2 stations)</span>
    <span class="n">Vxrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">),</span>  <span class="c1"># Constant axial velocity</span>
            <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>  <span class="c1"># No radial velocity</span>
            <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Vt2</span><span class="p">),</span>  <span class="c1"># Zero inlet swirl</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<p>Next, we need to calculate the static thermodynamic states. As we know
stagnation states and velocity vectors everywhere, this is most straightforward
to do by evaluating the static enthalpy <span class="math notranslate nohighlight">\(h=h_0-\frac{1}{2}V^2\)</span>. The
static and stagnation states have the same entropy. In code, this looks like:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># ...</span>

    <span class="c1"># Outlet stagnation state from known total rises</span>
    <span class="n">So2</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_P_h</span><span class="p">(</span><span class="n">So1</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">So1</span><span class="o">.</span><span class="n">h</span> <span class="o">+</span> <span class="n">Dho</span><span class="p">)</span>

    <span class="c1"># Assemble both stagnation states into a vector state</span>
    <span class="n">So</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">So1</span><span class="p">,</span><span class="n">So2</span><span class="p">))</span>

    <span class="c1"># Get static states using velocity magnitude and same entropy</span>
    <span class="n">Vmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Vxrt</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">So</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Vmag</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Static enthalpy</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">So</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_h_s</span><span class="p">(</span><span class="n">h</span> <span class="p">,</span> <span class="n">So</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<p>Now that the static states are known, the density can be used in the
conservation of mass equation to continue with evaluating areas, the RMS
radius, and the shaft angular velocity. The completed function is:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">So1</span><span class="p">,</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">mdot</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">htr</span><span class="p">,</span> <span class="n">etatt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Caluclate mean-line from inlet and design variables.&quot;&quot;&quot;</span>

    <span class="c1"># Get the ideal exit state</span>
    <span class="n">So2s</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Duplicate the inlet state</span>
    <span class="n">So2s</span><span class="o">.</span><span class="n">set_P_s</span><span class="p">(</span><span class="n">So1</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">So1</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># Set pressure and entropy</span>

    <span class="c1"># Work from defn efficiency Eqn. (1)</span>
    <span class="n">Dho</span> <span class="o">=</span> <span class="p">(</span><span class="n">So2s</span><span class="o">.</span><span class="n">h</span><span class="o">-</span><span class="n">So1</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="n">etatt</span>

    <span class="c1"># Blade speed from defn psi Eqn. (2)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Dho</span><span class="o">/</span><span class="n">psi</span><span class="p">)</span>

    <span class="c1"># Axial velocity from defn phi Eqn. (3)</span>
    <span class="n">Vx</span> <span class="o">=</span> <span class="n">phi</span><span class="o">*</span><span class="n">U</span>

    <span class="c1"># Circumferential velocity from Euler Eqn. (4)</span>
    <span class="n">Vt2</span> <span class="o">=</span> <span class="n">Dho</span><span class="o">/</span><span class="n">U</span>

    <span class="c1"># Assemble velocity vectors</span>
    <span class="c1"># shape (3 directions, 2 stations)</span>
    <span class="n">Vxrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">),</span>  <span class="c1"># Constant axial velocity</span>
            <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>  <span class="c1"># No radial velocity</span>
            <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">Vt2</span><span class="p">),</span>  <span class="c1"># Zero inlet swirl</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Outlet stagnation state from known total rises</span>
    <span class="n">So2</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_P_h</span><span class="p">(</span><span class="n">So1</span><span class="o">.</span><span class="n">P</span> <span class="o">+</span> <span class="n">DPo</span><span class="p">,</span> <span class="n">So1</span><span class="o">.</span><span class="n">h</span> <span class="o">+</span> <span class="n">Dho</span><span class="p">)</span>

    <span class="c1"># Assemble both stagnation states into a vector state</span>
    <span class="n">So</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">So1</span><span class="p">,</span><span class="n">So2</span><span class="p">))</span>

    <span class="c1"># Get static states using velocity magnitude and same entropy</span>
    <span class="n">Vmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Vxrt</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">So</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">Vmag</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Static enthalpy</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">So</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_h_s</span><span class="p">(</span><span class="n">h</span> <span class="p">,</span> <span class="n">So</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># Conservation of mass for annulus area, Eqn. (5)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">mdot</span><span class="o">/</span><span class="n">S</span><span class="o">.</span><span class="n">rho</span><span class="o">/</span><span class="n">Vx</span>

    <span class="c1"># Mean radius from HTR Eqn. (6)</span>
    <span class="n">rrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">htr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">htr</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Shaft angular velocity</span>
    <span class="n">Omega</span> <span class="o">=</span> <span class="n">U</span> <span class="o">/</span> <span class="n">rrms</span>

    <span class="c1"># Return assembled mean-line object</span>
    <span class="k">return</span> <span class="n">turbigen</span><span class="o">.</span><span class="n">flowfield</span><span class="o">.</span><span class="n">make_mean_line</span><span class="p">(</span>
        <span class="n">rrms</span><span class="p">,</span>  <span class="c1"># Mean radii</span>
        <span class="n">A</span><span class="p">,</span>  <span class="c1"># Annulus areas</span>
        <span class="n">Omega</span><span class="p">,</span>  <span class="c1"># Shaft angular velocity</span>
        <span class="n">Vxrt</span><span class="p">,</span> <span class="c1"># Velocity vectors</span>
        <span class="n">S</span>  <span class="c1"># Thermodynamic states</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>This concludes the <cite>forward</cite> function — all the required quantities have been
evaluated and can be returned for further processing.</p>
</section>
<section id="inverse-function">
<h2>Inverse function<a class="headerlink" href="#inverse-function" title="Link to this heading">¶</a></h2>
<p>If we run <strong class="program">turbigen</strong> on the <cite>config.yaml</cite> file now, it will complete
mean-line design successfully using the <cite>forward</cite> function, but raise an
Exception because the <cite>inverse</cite> function is incomplete.</p>
<p>The <cite>inverse</cite> function serves as a verification check that the mean-line
matches the design intent, and also to extract design variables from a
mixed-out CFD solution. We add the design variables as keys in the output
dictionary, using the attributes of the <a class="reference internal" href="meanline.html#turbigen.meanline.MeanLine" title="turbigen.meanline.MeanLine"><code class="xref py py-class docutils literal notranslate"><span class="pre">turbigen.meanline.MeanLine</span></code></a>
class to calculate them:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">fan.py</span><a class="headerlink" href="#id8" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="n">ml</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate design variables from a mean-line object.&quot;&quot;&quot;</span>

    <span class="n">So1</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">stagnation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">So2s</span> <span class="o">=</span> <span class="n">So1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_P_s</span><span class="p">(</span><span class="n">ml</span><span class="o">.</span><span class="n">Po</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ml</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ho2s</span> <span class="o">=</span> <span class="n">So2s</span><span class="o">.</span><span class="n">h</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;So1&quot;</span><span class="p">:</span> <span class="n">So1</span><span class="p">,</span>
        <span class="s1">&#39;DPo&#39;</span><span class="p">:</span> <span class="n">ml</span><span class="o">.</span><span class="n">Po</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ml</span><span class="o">.</span><span class="n">Po</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;mdot&#39;</span><span class="p">:</span> <span class="n">ml</span><span class="o">.</span><span class="n">mdot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;phi&#39;</span><span class="p">:</span> <span class="n">ml</span><span class="o">.</span><span class="n">Vx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ml</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;psi&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ml</span><span class="o">.</span><span class="n">ho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ml</span><span class="o">.</span><span class="n">ho</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">ml</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;etatt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ho2s</span><span class="o">-</span><span class="n">So1</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ml</span><span class="o">.</span><span class="n">ho</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ml</span><span class="o">.</span><span class="n">ho</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;htr&#39;</span><span class="p">:</span> <span class="n">ml</span><span class="o">.</span><span class="n">rhub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ml</span><span class="o">.</span><span class="n">rtip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="running-cfd">
<h2>Running CFD<a class="headerlink" href="#running-cfd" title="Link to this heading">¶</a></h2>
<p>We have now finished the mean-line design. To create blade shapes and run a
computational fluid dynamics simulation, we can add some extra code to the
<cite>config.yaml</cite>. These options are described fully in <a class="reference internal" href="config.html"><span class="doc">Configuration file format</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">config.yaml</span><a class="headerlink" href="#id9" title="Link to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># All files relating to the case are held in a working directory</span>
<span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runs/fan</span>

<span class="c1"># Perfect gas inlet state</span>
<span class="nt">inlet</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Po</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1e5</span>
<span class="w">    </span><span class="nt">To</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.</span>
<span class="w">    </span><span class="nt">cp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1005.</span>
<span class="w">    </span><span class="nt">mu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.8e-5</span>
<span class="w">    </span><span class="nt">gamma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.4</span>

<span class="c1"># Mean-line design</span>
<span class="nt">mean_line</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fan.py</span><span class="w">  </span><span class="c1"># Path to the mean-line module we are writing</span>
<span class="w">    </span><span class="c1"># Our chosen design variables (args to forward)</span>
<span class="w">    </span><span class="nt">DPo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000.</span>
<span class="w">    </span><span class="nt">mdot</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.</span>
<span class="w">    </span><span class="nt">phi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">    </span><span class="nt">psi</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span>
<span class="w">    </span><span class="nt">htr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.8</span>
<span class="w">    </span><span class="nt">etatt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9</span>

<span class="c1"># ADD annulus configuration</span>
<span class="nt">annulus</span><span class="p">:</span>
<span class="w">  </span><span class="nt">AR_gap</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># Span to inlet/exit boundary distance</span>
<span class="w">  </span><span class="nt">AR_chord</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.</span><span class="w">  </span><span class="c1"># Span to chord</span>
<span class="w">  </span><span class="nt">nozzle_ratio</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.9</span><span class="w">  </span><span class="c1"># Exit nozzle contraction</span>

<span class="c1"># ADD blade shapes</span>
<span class="nt">blades</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">DFL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.45</span><span class="w">  </span><span class="c1"># Set number of blades using Lieblein</span>
<span class="w">    </span><span class="nt">sections</span><span class="p">:</span><span class="w">  </span><span class="c1"># One blade section at midheight</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">spf</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">        </span><span class="nt">q_thick</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.18</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">qstar_camber</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.0</span><span class="p p-Indicator">]</span>

<span class="c1"># ADD mesh generation</span>
<span class="nt">mesh</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">h</span><span class="w">  </span><span class="c1"># Mesh topology</span>
<span class="w">  </span><span class="nt">yplus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0</span><span class="w">  </span><span class="c1"># Non-dimensional wall distance</span>
<span class="w">  </span><span class="nt">resolution_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w">  </span><span class="c1"># Use a coarse mesh</span>

<span class="c1"># ADD CFD solver</span>
<span class="nt">solver</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ts3</span><span class="w">  </span><span class="c1"># Use Turbostream 3</span>
<span class="w">  </span><span class="nt">nstep</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="w">  </span><span class="nt">nstep_avg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
<span class="w">  </span><span class="nt">ilos</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w">  </span><span class="c1"># Mixing-length turbulence model</span>
<span class="w">  </span><span class="nt">fmgrid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4</span><span class="w">  </span><span class="c1"># Full multigrid</span>

<span class="c1"># ADD control mass flow using a PID on exit pressure</span>
<span class="nt">operating_point</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mdot_pid</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.5</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">0.0</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<p>If we now run <strong class="program">turbigen</strong> on our <cite>config.yaml</cite> using the shell command,
we can quickly obtain a CFD solution for our newly designed fan.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>turbigen<span class="w"> </span>config.yaml
<span class="go">TURBIGEN v1.5.1</span>
<span class="go">Starting at 2024-01-29T13:57:10</span>
<span class="go">Working directory: ...</span>
<span class="go">Inlet: PerfectState(P=1.000 bar, T=300.0 K)</span>
<span class="go">Designing a fan.py...</span>
<span class="go">MeanLine(</span>
<span class="go">    Po=[1.   1.02] bar,</span>
<span class="go">    To=[300.     301.8913] K,</span>
<span class="go">    Ma=[0.099 0.127],</span>
<span class="go">    Vx=[34.5 34.5],</span>
<span class="go">    Vr=[0. 0.],</span>
<span class="go">    Vt=[ 0.  27.6],</span>
<span class="go">    Vt_rel=[-68.9 -41.4],</span>
<span class="go">    Al=[ 0.   38.66],</span>
<span class="go">    Al_rel=[-63.43 -50.19],</span>
<span class="go">    rpm=[2182. 2193.],</span>
<span class="go">    mdot=[5. 5.] kg/s</span>
<span class="go">    )</span>
<span class="go">Checking mean-line conservation...</span>
<span class="go">Checking mean-line inversion...</span>
<span class="go">Annulus(</span>
<span class="go">    xmid=[-7.5253e-07  2.2099e-02],</span>
<span class="go">    rmid=[0.2999 0.2983],</span>
<span class="go">    span=[0.0666 0.0663]</span>
<span class="go">    )</span>
<span class="go">Re_surf/10^5=[2.]</span>
<span class="go">Nblade=[54], s_cm=[1.57], tip=[0.]</span>
<span class="go">Generating an H-mesh...</span>
<span class="go">Mesh Npts/10^6=0.11</span>
<span class="go">Applying boundary conditions...</span>
<span class="go">Setting intial guess...</span>
<span class="go">Calculating wall distance...</span>
<span class="go">Running solver ts3...</span>
<span class="go">Using 1 GPUs on 1 nodes, 1 per node.</span>
<span class="go">Checking convergence over last 5000 steps...</span>
<span class="go">mdot drift = 0.0%, mdot error = -0.3%, eta_drift = -0.0%</span>
<span class="go">Post-processing...</span>
<span class="go">Mixed-out CFD result:</span>
<span class="go">MeanLine(</span>
<span class="go">    Po=[0.9997 1.0115] bar,</span>
<span class="go">    To=[300.0521 301.2397] K,</span>
<span class="go">    Ma=[0.099 0.113],</span>
<span class="go">    Vx=[34.5 34.6],</span>
<span class="go">    Vr=[ 0.4 -0.8],</span>
<span class="go">    Vt=[ 0.8 18.2],</span>
<span class="go">    Vt_rel=[-68.1 -50.7],</span>
<span class="go">    Al=[ 1.35 27.72],</span>
<span class="go">    Al_rel=[-63.17 -55.69],</span>
<span class="go">    rpm=[2182. 2193.],</span>
<span class="go">    mdot=[5. 5.] kg/s</span>
<span class="go">    )</span>
<span class="go">Design variable Nom    CFD</span>
<span class="go">------------------------------</span>
<span class="go">DPo             2000.0 1172.7</span>
<span class="go">etatt           0.9000 0.8433</span>
<span class="go">htr             0.8000 0.8000</span>
<span class="go">mdot            5.0000 4.9961</span>
<span class="go">phi             0.5000 0.4997</span>
<span class="go">psi             0.4000 0.2511</span>
<span class="go">eta_tt=0.843, eta_ts=0.203</span>
<span class="go">Elapsed time 1.40 min.</span>
</pre></div>
</div>
<p>Creating and running designs with different velocity triangles is as simple as
changing a line or two in the mean-line section of <cite>config.yaml</cite>. This allows
us to explore a new design space very quickly.</p>
</section>
<section id="iterating-the-design">
<h2>Iterating the design<a class="headerlink" href="#iterating-the-design" title="Link to this heading">¶</a></h2>
<p>The table at the end of the program output compares the nominal mean-line
design variables to actual values calculated using cuts from the
three-dimensional CFD solution (the cuts are mixed out at constant area).
Inspecting the output for our new fan, we can identify several problems:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Design variable Nom    CFD</span>
<span class="go">------------------------------</span>
<span class="go">DPo             2000.0 1172.7  # Pressure rise too low</span>
<span class="go">etatt           0.9000 0.8433  # Guessed efficiency too high</span>
<span class="go">htr             0.8000 0.8000</span>
<span class="go">mdot            5.0000 4.9961</span>
<span class="go">phi             0.5000 0.4997</span>
<span class="go">psi             0.4000 0.2511  # Loading too low</span>
</pre></div>
</div>
<p>The root cause of the lack of pressure rise is that we have not allowed for
deviation in designing the blade shapes, hence the flow is underturned.
Assuming a guess of efficiency was neccesary to complete mean-line design, but
its value should be updated so that the annulus areas are compatible with the
intended velocity triangles.</p>
<p>Although it is not evident from the table, the inlet flow is not precisely
aligned with the inlet metal angle, leading to unwanted accelerations around
the leading edge. We should locate the stagnation point on the nose of the
aerofoil to yield the smoothest pressure distributions.</p>
<p><strong class="program">turbigen</strong> has the capability to correct for all these issues. Adding
an <cite>iterate</cite> key to the <cite>config.yaml</cite> will cause the program to repeatedly run
the CFD, updating the efficiency guess and recambering the leading and trailing
edges as needed:</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">config.yaml</span><a class="headerlink" href="#id10" title="Link to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>

<span class="c1"># ADD new section for iterative corrections</span>
<span class="nt">iterate</span><span class="p">:</span>
<span class="nt">mean_line</span><span class="p">:</span><span class="w">  </span><span class="c1"># Correct efficiency guess</span>
<span class="w">  </span><span class="nt">match_tolerance</span><span class="p">:</span>
<span class="w">    </span><span class="nt">etatt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span><span class="w">  </span><span class="c1"># Efficiency to within 1%</span>
<span class="w">  </span><span class="nt">relaxation_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w">  </span><span class="c1"># Change is half CFD minus nominal</span>
<span class="nt">deviation</span><span class="p">:</span><span class="w">  </span><span class="c1"># Correct exit flow angles by TE recamber</span>
<span class="w">  </span><span class="nt">clip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0</span><span class="w">  </span><span class="c1"># Maximum recamber in one step</span>
<span class="w">  </span><span class="nt">relaxation_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.8</span><span class="w">  </span><span class="c1"># Multiplier on changes to metal angle</span>
<span class="w">  </span><span class="nt">tolerance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span><span class="w">  </span><span class="c1"># Absolute tolerance for termination in degrees</span>
<span class="nt">incidence</span><span class="p">:</span><span class="w">  </span><span class="c1"># Correct incidence by LE recamber</span>
<span class="w">  </span><span class="nt">clip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0</span><span class="w">   </span><span class="c1"># Maximum recamber in one step</span>
<span class="w">  </span><span class="nt">relaxation_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span><span class="w">  </span><span class="c1"># Multiplier on changes to metal angle</span>
<span class="w">  </span><span class="nt">tolerance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.0</span><span class="w">  </span><span class="c1"># Absolute tolerance for termination in degrees</span>
</pre></div>
</div>
</div>
<p>Running the extended input file gives:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>turbigen<span class="w"> </span>config.yaml
<span class="go">TURBIGEN v1.5.1</span>
<span class="go">Starting at 2024-01-29T09:58:58</span>
<span class="go">Working directory: ...</span>
<span class="go">Iterating for max_iter=20 iterations</span>
<span class="go">Min   Inc   DInc  Dev   DDev  etatt Detatt</span>
<span class="go">-------------------------------------------</span>
<span class="go">1.401 6.271 1.254 -5.49 4.398 0.844 -0.002</span>
<span class="go">1.401 4.064 0.812 -2.56 2.051 0.893 0.0232</span>
<span class="go">1.401 2.502 0.500 -1.24 0.996 0.907 0.0182</span>
<span class="go">1.401 1.491 0.298 -0.60 0.482 0.911 0.0115</span>
<span class="go">1.401 0.885 0.177 -0.32 0.258 0.913 0.0067</span>
<span class="go">1.401 0.497 0.099 -0.11 0.093 0.915 0.0041</span>
<span class="go">Design variable Nom    CFD</span>
<span class="go">------------------------------</span>
<span class="go">DPo             2000.0 1932.2</span>
<span class="go">etatt           0.9111 0.9153</span>
<span class="go">htr             0.8000 0.8000</span>
<span class="go">mdot            5.0000 4.9941</span>
<span class="go">phi             0.5000 0.4995</span>
<span class="go">psi             0.4000 0.3832</span>
<span class="go">eta_tt=0.915, eta_ts=0.383</span>
<span class="go">Iteration finished in 8.4 min.</span>
</pre></div>
</div>
<p>The corrections applied, <cite>DInc</cite>, <cite>DDev</cite>, and <cite>Detatt</cite>, decrease with each
iteration indicating stable convergence. When the iteration terminates, the
mixed-out CFD solution corresponds closely to the design intent. A new
configuration file has been written out in the working directory
<cite>runs/fan/config_conv.yaml</cite> for the converged solution. Inspecting this file:</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">config_conv.yaml</span><a class="headerlink" href="#id11" title="Link to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="nt">qstar_camber</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.142689298065078</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8.280434755893827</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="c1"># ...</span>
</pre></div>
</div>
</div>
<p>Under the <cite>qstar_camber</cite> key that defines the camber line, we see that 3.1
degrees of recamber was required to align the stagnation point, and the
deviation was 8.3 degrees. The efficiency has also been updated to 91.5%.</p>
</section>
<section id="extensions">
<h2>Extensions<a class="headerlink" href="#extensions" title="Link to this heading">¶</a></h2>
<p>This tutorial has demonstrated some of the functionality of
<strong class="program">turbigen</strong>. With the current choice of parameterisation, any change to
the design is just an edit to the <cite>config.yaml</cite>, as described in <a class="reference internal" href="config.html"><span class="doc">Configuration file format</span></a>.</p>
<ul class="simple">
<li><p>Increase the number of blades by changing <cite>DFL</cite></p></li>
<li><p>Increase the grid density under <cite>mesh</cite></p></li>
<li><p>Control camber and thickness distributions by changing <cite>qthick</cite> and <cite>qstar_camber</cite></p></li>
<li><p>Specify blade sections at multiple spanwise locations</p></li>
<li><p>Change the aspect ratio <cite>AR_chord</cite></p></li>
<li><p>With a compatible CFD solver, change the working fluid to a real gas under <cite>inlet</cite></p></li>
</ul>
<p>To change the mean-line design, edit the <cite>forward</cite> and <cite>inverse</cite> functions in
<cite>fan.py</cite>. For example: relax the assumption of constant axial velocity by
adding a velocity ratio as one of the arguments to forward, replace
specification of loading coefficient with a de Haller number, or specify an
inlet Mach number instead of mass flow rate.</p>
<p>To add a stator, extend <cite>forward</cite> to take additional design variables and
perform the necessary calculations. The output data should be at the inlet and
exit of both blade rows, e.g. <cite>A</cite> an array of length 4, the velocity vectors
should be of shape (3,4).</p>
</section>
</section>


          </div>

        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2024 James Brind.

      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>

      |
      <a href="_sources/tutorial.rst.txt"
          rel="nofollow">Page source</a>
    </div>




  </body>
</html>
