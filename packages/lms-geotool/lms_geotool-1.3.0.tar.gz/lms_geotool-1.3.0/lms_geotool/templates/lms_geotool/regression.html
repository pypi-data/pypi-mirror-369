<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>线性回归</title>
    {% include "common.html" %}
</head>
<body>
<div id="regression">
    <h3>线性回归</h3>
    <el-divider></el-divider>
    <el-row :gutter="50">
        <el-col :span="6">
            <h4>映射坐标</h4>
            <el-table :data="samplepoint">
                <el-table-column prop="x" label="特征变量X"></el-table-column>
                <el-table-column prop="y" label="目标变量Y"></el-table-column>
            </el-table>
            <br>
            <form class="regression-form" method="post" action="{% url 'regression' %}?lrid={{ lrid }}">
                {% csrf_token %}
                <el-space :size="30">
                    <el-input v-model="input_value" style="width: 240px" name="input_value" size="large" placeholder="输入特征变量"></el-input>
                    <el-button type="primary" size="large" @click="onSubmit">提交</el-button>
                </el-space>

            </form>
            <div class="translation-result">

                {% if output_value %}
                    <h3>输出结果</h3>
                    <span>{{ output_value }}</span>
                {% endif %}
            </div>
        </el-col>

        <el-col :span="18">
            <h4>基础信息</h4>
            <el-descriptions column="4" border>
                <el-descriptions-item>
                    <template #label>规则编码</template>
                    <span>{{ lrid }}</span>
                </el-descriptions-item>

                <el-descriptions-item>
                    <template #label>规则名称</template>
                    <span>{{ name }}</span>
                </el-descriptions-item>

                <el-descriptions-item>
                    <template #label>权重</template>
                    <span>{{ k }}</span>
                </el-descriptions-item>

                <el-descriptions-item>
                    <template #label>偏置</template>
                    <span>{{ b }}</span>
                </el-descriptions-item>
            </el-descriptions>

            <h4>函数图像</h4>
            <div id="chart-container" style="width: 100%; height: 500px;"></div>
        </el-col>
    </el-row>


</div>
</body>
</html>
<script>
    const {createApp, ref, reactive, watch, onMounted} = Vue
    const App = {
        setup() {
            const samplepoint = JSON.parse('{{ samplepoint|safe }}');
            const k = {{ k }}
            const b = {{ b }}

            const max_x = {{ max_x }}
            const min_x = {{ min_x }}
            const max_y = {{ max_y }}
            const min_y = {{ min_y }}

            const input_value = ref("")

            const markLineOpt = {
                animation: false,
                lineStyle: {type: 'solid'},
                tooltip: {formatter: `y = ${k} * x + ${b}`},
                data: [
                    [
                        {
                            coord: [(min_y - b) / k, min_y],
                            symbol: 'none'
                        },
                        {
                            coord: [(max_y - b) / k, max_y],
                            symbol: 'none'
                        }
                    ]
                ]
            };
            onMounted(() => {
                const chartDom = document.getElementById('chart-container');
                const myChart = echarts.init(chartDom);
                option = {
                    tooltip: {
                        formatter: '{c}'
                    },
                    grid: [
                        {left: '0%', top: '0%', width: '90%', height: '100%'},
                    ],
                    xAxis: [
                        {
                            min: Math.min(min_x, Math.round((min_y - b) / k, 2)) - 1,
                            max: Math.max(max_x, Math.round((max_y - b) / k, 2)) + 1
                        }
                    ],
                    yAxis: [
                        {min: min_y, max: max_y}
                    ],
                    series: [
                        {
                            name: '回归曲线',
                            type: 'scatter',
                            clip: true,
                            data: samplepoint.map(item => [item.x, item.y]),
                            markLine: markLineOpt
                        }
                    ]
                };
                myChart.setOption(option);
                console.log(markLineOpt)
                window.addEventListener('resize', function () {
                    myChart.resize();
                });
            })
            const onSubmit = () => {
                let forms = document.getElementsByClassName('regression-form')[0];
                forms.submit();
            }
            return {
                samplepoint,
                input_value,
                onSubmit
            }
        }
    }

    const app = createApp(App)
    app.use(ElementPlus, {
        locale: ElementPlusLocaleZhCn,
    })
    app.mount('#regression')
</script>
<style>
    #regression {
        text-align: center;
        width: 95%;
        margin: auto;
        height: 95vh;
    }
</style>
