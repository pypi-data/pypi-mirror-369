# =============================================================================
# Agent Development Container - All-in-One PostgreSQL + FastAPI  
# =============================================================================
#
# Unified container architecture for agent development and testing:
# - PostgreSQL database with pgvector extension (internal port 5432)
# - FastAPI application with Agent development API (external port 35532)
# - Supervisord process management for multi-service coordination
# - Complete isolation from main workspace and Genie container
#
# Usage:
#   docker-compose -f docker-compose-agent.yml up -d
#   docker-compose -f docker-compose-agent.yml logs -f
#   docker-compose -f docker-compose-agent.yml down
#
# Integration:
#   uvx automagik-hive --agent-serve     # Start Agent container
#   uvx automagik-hive --agent-logs      # View Agent logs
#   uvx automagik-hive --agent-stop      # Stop Agent container
#
# =============================================================================

# Shared build arguments for Agent container
x-agent-build-args: &agent-build-args
  BUILD_VERSION: ${BUILD_VERSION:-latest}
  BUILD_DATE: ${BUILD_DATE:-$(date -u +%Y-%m-%dT%H:%M:%SZ)}
  GIT_SHA: ${GIT_SHA:-$(git rev-parse HEAD 2>/dev/null || echo "unknown")}
  API_PORT: 35532
  CONTAINER_TYPE: agent

services:
  # Standalone PostgreSQL for Agent Development
  postgres-agent:
    image: agnohq/pgvector:16
    container_name: hive-postgres-agent
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "35532:5432"  # Agent PostgreSQL port
    env_file:
      - .env
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - ../../data/postgres-agent:/var/lib/postgresql/data
    networks:
      - agent_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Agent FastAPI Service (connects to postgres-agent)
  agent-dev-server:
    build:
      context: ../../
      dockerfile: docker/agent/Dockerfile.agent
      args:
        <<: *agent-build-args
      platforms:
        - linux/amd64
      target: agent-production
    container_name: hive-agent-dev-server
    restart: unless-stopped
    ports:
      - "38886:38886"  # Agent development API (different from postgres port)
    env_file:
      - .env
    environment:
      # Agent-specific database connection (connects to postgres-agent service)
      - HIVE_DATABASE_URL=postgresql+psycopg://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres-agent:5432/$POSTGRES_DB
      - RUNTIME_ENV=prd
    volumes:
      - agent_app_logs:/app/logs                        # Application logs
      - agent_app_data:/app/data                        # Application data
    depends_on:
      postgres-agent:
        condition: service_healthy
    networks:
      - agent_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:38886/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Agent network configuration
networks:
  agent_network:
    driver: bridge
    name: hive_agent_network

# Agent persistent volumes
volumes:
  agent_app_logs:
    driver: local
    name: hive_agent_app_logs
  agent_app_data:
    driver: local
    name: hive_agent_app_data
  agent_supervisor_logs:
    driver: local
    name: hive_agent_supervisor_logs