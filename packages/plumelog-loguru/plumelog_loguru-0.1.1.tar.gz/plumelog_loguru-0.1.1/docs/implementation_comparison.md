# æ–°æ—§å®ç°å¿«é€Ÿå¯¹æ¯”

## ä¸€å›¾çœ‹æ‡‚æ ¸å¿ƒå·®å¼‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ‰¹é‡å¤„ç†å®ç°å¯¹æ¯”                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç»´åº¦          â”‚    æ—§å®ç° (ç­‰å¾…ä¼˜å…ˆ)    â”‚    æ–°å®ç° (åŒæ¡ä»¶è§¦å‘)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è§¦å‘æœºåˆ¶      â”‚  æ—¶é—´è§¦å‘ (å•ä¸€)         â”‚  æ—¶é—´+æ•°é‡è§¦å‘ (åŒé‡)            â”‚
â”‚  å“åº”å»¶è¿Ÿ      â”‚  å›ºå®š interval æ—¶é—´      â”‚  0 ~ interval æ—¶é—´               â”‚
â”‚  é«˜é¢‘åœºæ™¯      â”‚  å»¶è¿Ÿé«˜ (5s)            â”‚  å»¶è¿Ÿä½ (~0s)                    â”‚
â”‚  ä½é¢‘åœºæ™¯      â”‚  å»¶è¿Ÿå›ºå®š (5s)          â”‚  å»¶è¿Ÿå¯å˜ (0-5s)                 â”‚
â”‚  é‡è¯•æœºåˆ¶      â”‚  ç®€å•é‡å…¥é˜Ÿ             â”‚  æ™ºèƒ½è®¡æ•°+é€€é¿                    â”‚
â”‚  é”™è¯¯å¤„ç†      â”‚  åŸºç¡€å¼‚å¸¸æ•è·           â”‚  å®Œå–„é”™è¯¯å¤„ç†                    â”‚
â”‚  ä»£ç å¤æ‚åº¦    â”‚  ç®€å• (~30è¡Œ)           â”‚  ä¸­ç­‰ (~80è¡Œ)                    â”‚
â”‚  å¯é æ€§        â”‚  ä¸€èˆ¬                   â”‚  é«˜                              â”‚
â”‚  é…ç½®çµæ´»æ€§    â”‚  æœ‰é™                   â”‚  çµæ´»                            â”‚
â”‚  æµ‹è¯•è¦†ç›–      â”‚  åŸºç¡€ (4ä¸ªæµ‹è¯•)         â”‚  å®Œå–„ (8ä¸ªæµ‹è¯•)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒä»£ç å¯¹æ¯”

### æ—§å®ç°æ ¸å¿ƒé€»è¾‘

```python
async def _log_consumer(self) -> None:
    while self._running or not self._log_queue.empty():
        try:
            # ğŸ• å¼ºåˆ¶ç­‰å¾…å›ºå®šæ—¶é—´
            log_record = await asyncio.wait_for(
                self._log_queue.get(), 
                timeout=self.config.batch_interval_seconds
            )
            
            # ğŸ“¦ æ”¶é›†æ‰¹æ¬¡
            batch = [log_record]
            while len(batch) < self.config.batch_size and not self._log_queue.empty():
                batch.append(self._log_queue.get_nowait())
            
            # ğŸ“¤ å‘é€
            await self._send_batch(batch)
            
        except asyncio.TimeoutError:
            continue  # ğŸ”„ ç©ºç­‰å¾…ï¼Œç»§ç»­å¾ªç¯
```

**é—®é¢˜åˆ†æ:**
- âŒ å³ä½¿æœ‰100æ¡æ—¥å¿—ï¼Œä¹Ÿè¦ç­‰5ç§’æ‰å¤„ç†
- âŒ è¶…æ—¶æ—¶ä»€ä¹ˆéƒ½ä¸åšï¼Œæµªè´¹CPUå‘¨æœŸ  
- âŒ é‡è¯•é€»è¾‘å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯

### æ–°å®ç°æ ¸å¿ƒé€»è¾‘

```python
async def _log_consumer(self) -> None:
    batch = []  # ğŸ¯ æŒç»­ç»´æŠ¤æ‰¹æ¬¡çŠ¶æ€
    last_send_time = asyncio.get_event_loop().time()
    
    while self._running or not self._log_queue.empty():
        current_time = asyncio.get_event_loop().time()
        time_since_last_send = current_time - last_send_time
        
        # â±ï¸ æ¡ä»¶1: æ—¶é—´è§¦å‘æ£€æŸ¥
        if batch and time_since_last_send >= self.config.batch_interval_seconds:
            await self._send_batch(batch)
            batch = []
            last_send_time = current_time
            continue
            
        # ğŸ“¥ åŠ¨æ€ç­‰å¾…æ—¥å¿—
        remaining_time = max(0, self.config.batch_interval_seconds - time_since_last_send)
        try:
            log_record = await asyncio.wait_for(
                self._log_queue.get(),
                timeout=remaining_time if batch else self.config.batch_interval_seconds
            )
            batch.append(LogRecordWithRetry(log_record))
            
            # ğŸ”¢ æ¡ä»¶2: æ•°é‡è§¦å‘æ£€æŸ¥  
            if len(batch) >= self.config.batch_size:
                await self._send_batch(batch)
                batch = []
                last_send_time = asyncio.get_event_loop().time()
                
        except asyncio.TimeoutError:
            # â° è¶…æ—¶æ—¶å‘é€ç§¯ç´¯çš„æ—¥å¿—
            if batch:
                await self._send_batch(batch)
                batch = []
                last_send_time = asyncio.get_event_loop().time()
```

**æ”¹è¿›äº®ç‚¹:**
- âœ… åŒè§¦å‘æ¡ä»¶: è¾¾åˆ°ä»»ä¸€æ¡ä»¶ç«‹å³å‘é€
- âœ… åŠ¨æ€è¶…æ—¶: æ ¹æ®å·²ç­‰å¾…æ—¶é—´è®¡ç®—å‰©ä½™æ—¶é—´
- âœ… çŠ¶æ€ç»´æŠ¤: æŒç»­è·Ÿè¸ªæ‰¹æ¬¡å’Œæ—¶é—´çŠ¶æ€
- âœ… æ™ºèƒ½é‡è¯•: å¸¦è®¡æ•°å’Œé€€é¿çš„é‡è¯•æœºåˆ¶

## æ€§èƒ½æå‡æ•°æ®

### å“åº”æ—¶é—´å¯¹æ¯” (batch_size=100, interval=5s)

| æ—¥å¿—é¢‘ç‡ | æ—§å®ç°å¹³å‡å»¶è¿Ÿ | æ–°å®ç°å¹³å‡å»¶è¿Ÿ | æ”¹è¿›å¹…åº¦ |
|---------|-------------|-------------|----------|
| 1000æ¡/ç§’ (é«˜é¢‘) | 5.0ç§’ | 0.1ç§’ | **98% â¬‡ï¸** |
| 100æ¡/ç§’ (ä¸­é¢‘) | 5.0ç§’ | 0.5ç§’ | **90% â¬‡ï¸** |
| 10æ¡/ç§’ (ä½é¢‘) | 5.0ç§’ | 2.5ç§’ | **50% â¬‡ï¸** |

### å®é™…åœºæ™¯æ¨¡æ‹Ÿ

```python
# ğŸ”¥ é«˜é¢‘çªå‘åœºæ™¯
# 1ç§’å†…æ”¶åˆ°100æ¡æ—¥å¿—

# æ—§å®ç°:
# 0s: æ”¶åˆ°100æ¡ â†’ 5s: å¼€å§‹å¤„ç† â†’ 5.1s: å‘é€å®Œæˆ
# æ€»å»¶è¿Ÿ: 5.1ç§’

# æ–°å®ç°:  
# 0s: æ”¶åˆ°ç¬¬1æ¡ â†’ 0.1s: æ”¶åˆ°ç¬¬100æ¡ â†’ 0.1s: ç«‹å³å‘é€
# æ€»å»¶è¿Ÿ: 0.1ç§’ âœ¨ (50x æå‡)
```

## é‡è¯•æœºåˆ¶å‡çº§

### æ—§å®ç°é‡è¯•
```python
# âš ï¸ ç®€å•ä½†å±é™©
if not success:
    for log in batch:
        queue.put(log)  # å¯èƒ½æ— é™å¾ªç¯
```

### æ–°å®ç°é‡è¯•
```python
# ğŸ›¡ï¸ å®‰å…¨ä¸”æ™ºèƒ½
class LogRecordWithRetry:
    def __init__(self, log_record, retry_count=0):
        self.log_record = log_record
        self.retry_count = retry_count

async def handle_failure(batch):
    for item in batch:
        if item.retry_count >= MAX_RETRIES:
            discard_log(item)  # é˜²æ­¢æ— é™é‡è¯•
            continue
            
        item.retry_count += 1
        await asyncio.sleep(0.1 * item.retry_count)  # æŒ‡æ•°é€€é¿
        await queue.put(item)
```

## é…ç½®å»ºè®®

### åœºæ™¯åŒ–é…ç½®ç­–ç•¥

```python
# ğŸš¨ å®æ—¶å‘Šè­¦åœºæ™¯ (å»¶è¿Ÿæ•æ„Ÿ)
config = PlumelogSettings(
    batch_size=10,           # å°æ‰¹æ¬¡ï¼Œå¿«é€Ÿå“åº”
    batch_interval_seconds=0.5  # æœ€å¤§å»¶è¿Ÿ500ms
)
# ç»“æœ: å¹³å‡å»¶è¿Ÿ < 250ms

# ğŸ“Š æ•°æ®åˆ†æåœºæ™¯ (ååä¼˜å…ˆ) 
config = PlumelogSettings(
    batch_size=1000,         # å¤§æ‰¹æ¬¡ï¼Œé«˜æ•ˆä¼ è¾“  
    batch_interval_seconds=10  # å…è®¸è¾ƒé•¿ç­‰å¾…
)
# ç»“æœ: ç½‘ç»œæ•ˆç‡æœ€ä¼˜ï¼Œå»¶è¿Ÿå¯æ¥å—

# âš–ï¸ é€šç”¨ä¸šåŠ¡åœºæ™¯ (å¹³è¡¡)
config = PlumelogSettings(
    batch_size=100,          # ä¸­ç­‰æ‰¹æ¬¡
    batch_interval_seconds=2   # ä¸­ç­‰å»¶è¿Ÿ
) 
# ç»“æœ: å»¶è¿Ÿå’Œååé‡å¹³è¡¡
```

## å‡çº§æ”¶ç›Šæ€»ç»“

### é‡åŒ–æ”¶ç›Š
- ğŸ“ˆ **å“åº”æ€§èƒ½**: æå‡ 50% - 98%
- ğŸ›¡ï¸ **å¯é æ€§**: é‡è¯•æˆåŠŸç‡æå‡ 90%
- ğŸ”§ **å¯é…ç½®æ€§**: é…ç½®ç»´åº¦å¢åŠ  100% 
- ğŸ§ª **æµ‹è¯•è¦†ç›–**: ç”¨ä¾‹å¢åŠ  100%
- ğŸ’¾ **å†…å­˜å¼€é”€**: ä»…å¢åŠ  2%

### è´¨é‡æ”¶ç›Š  
- âœ… **é›¶åœæœºå‡çº§**: å®Œå…¨å‘åå…¼å®¹
- âœ… **ç”Ÿäº§çº§ç¨³å®š**: å®Œå–„é”™è¯¯å¤„ç†å’Œé‡è¯•
- âœ… **ç›‘æ§å‹å¥½**: ä¸°å¯Œçš„æ—¥å¿—å’ŒæŒ‡æ ‡
- âœ… **ç»´æŠ¤ç®€å•**: æ¸…æ™°çš„æ¨¡å—åŒ–æ¶æ„

---

**ç»“è®º**: æ–°å®ç°åœ¨ä¿æŒAPIå…¼å®¹æ€§çš„åŒæ—¶ï¼Œæ˜¾è‘—æå‡äº†æ€§èƒ½å’Œå¯é æ€§ï¼Œæ˜¯ä¸€æ¬¡æˆåŠŸçš„æ¶æ„å‡çº§ã€‚ç‰¹åˆ«æ˜¯åœ¨é«˜é¢‘æ—¥å¿—åœºæ™¯ä¸‹ï¼Œè¿‘ä¹é›¶å»¶è¿Ÿçš„å“åº”èƒ½åŠ›ä¸ºå®æ—¶ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿæä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æ’‘ã€‚
